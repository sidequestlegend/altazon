var UltimateLoader=UltimateLoader||{};!function(e){"use strict";function t(e,t,r){m.push([e,t,r])}function r(){if(v>m.length-1)return m=[],void(v=0);var e=m[v];v++,a(e[0],e[1],e[2])}function i(){0==v&&r()}function a(e,t,i){var a=s(n(e));switch(a.url=e,a.callback=t,null!=i&&(a.i=i),a.ext){case"obj":o(a);break;case"json":c(a);break;case"dae":h(a);break;case"gltf":case"glb":u(a);break;case"fbx":loadFBX(a);break;case"drc":loadDRACO(a);break;case"png":case"jpg":case"jpeg":l(a);break;default:console.log("UltimateLoader: File extension -"+a.ext+"- not recognized! Object -"+a.name+"- did not load."),r()}}function s(e){var t=e.slice(0,e.lastIndexOf("/")+1),r=e.substr(e.lastIndexOf("/")+1).split(".");return{name:r[0],ext:r[r.length-1].toLowerCase(),baseUrl:t}}function n(e,t){return"string"!=typeof e||""===e?"":/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:new URL((t||"")+e,location.href.substring(0,location.href.lastIndexOf("/")+1)).toString()}function o(e){var t=e.name+".obj",r=e.name+".mtl",i=new THREE.MTLLoader;i.setPath(e.baseUrl),i.setTexturePath?i.setTexturePath(e.baseUrl):i.setBaseUrl(e.baseUrl),i.setCrossOrigin(E),i.load(r,function(r){r.preload();var i=new THREE.OBJLoader;i.setMaterials(r),i.setPath(e.baseUrl),i.load(t,function(t){e.object=t,f(e)},d,p)})}function c(e){(new THREE.ObjectLoader).load(e.url,function(t){e.object=t,f(e)},d,p)}function h(e){(new THREE.ColladaLoader).load(e.url,function(t){var r=t.scene;e.object=r,f(e)},d,p)}function l(t){(new THREE.TextureLoader).load(t.url,function(r){var i=r;if(e.loadImagesOnPlane){var a=r.image.naturalHeight/r.image.naturalWidth*e.imageSize,s=new THREE.PlaneGeometry(e.imageSize,a,e.imageSize),n=new THREE.MeshBasicMaterial({map:r,side:THREE.DoubleSide});i=new THREE.Mesh(s,n)}t.object=i,f(t)},d,p)}function u(e){(new THREE.GLTFLoader).load(e.url,function(t){var r=t.scene;r.traverse(function(e){if(e instanceof THREE.Mesh&&e.material instanceof THREE.Material)for(var t=0;t<textureArray.length;t++){var r=textureArray[t].image.src.replace(/^.*[\\\/]/,"");r=r.substring(0,r.indexOf(".")),e.material.name===r&&(e.material.map=textureArray[t])}}),e.object=r,f(e)},d,p)}function d(e){}function p(e){console.log("There was an error loading your object")}function f(t){null!=t.i?t.callback(t):t.callback(t.object),e.useQueue&&r(),console.log("UltimateLoader: Object "+t.name+" loaded!")}var m=[],v=0,E="anonymous";e.useQueue=!1,e.imageSize=32,e.loadImagesOnPlane=!1,e.load=function(r,s){e.useQueue?(t(r,s),i()):a(r,s)},e.multiload=function(r,s){console.time("Time");for(var n=[],o=0,c=function(e){n[e.i]=e.object,++o==r.length&&(s(n),console.timeEnd("Time"))},h=0;h<r.length;h++)e.useQueue?(t(r[h],c,h),i()):a(r[h],c,h)}}(UltimateLoader),THREE.FileLoader=THREE.FileLoader||THREE.XHRLoader,THREE.MTLLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.MTLLoader.prototype={constructor:THREE.MTLLoader,load:function(e,t,r,i){var a=this,s=new THREE.FileLoader(this.manager);s.setPath(this.path),s.load(e,function(e){t(a.parse(e))},r,i)},setPath:function(e){this.path=e},setTexturePath:function(e){this.texturePath=e},setBaseUrl:function(e){console.warn("THREE.MTLLoader: .setBaseUrl() is deprecated. Use .setTexturePath( path ) for texture path or .setPath( path ) for general base path instead."),this.setTexturePath(e)},setCrossOrigin:function(e){this.crossOrigin=e},setMaterialOptions:function(e){this.materialOptions=e},parse:function(e){for(var t=e.split("\n"),r={},i=/\s+/,a={},s=0;s<t.length;s++){var n=t[s];if(0!==(n=n.trim()).length&&"#"!==n.charAt(0)){var o=n.indexOf(" "),c=o>=0?n.substring(0,o):n;c=c.toLowerCase();var h=o>=0?n.substring(o+1):"";if(h=h.trim(),"newmtl"===c)r={name:h},a[h]=r;else if(r)if("ka"===c||"kd"===c||"ks"===c){var l=h.split(i,3);r[c]=[parseFloat(l[0]),parseFloat(l[1]),parseFloat(l[2])]}else r[c]=h}}var u=new THREE.MTLLoader.MaterialCreator(this.texturePath||this.path,this.materialOptions);return u.setCrossOrigin(this.crossOrigin),u.setManager(this.manager),u.setMaterials(a),u}},THREE.MTLLoader.MaterialCreator=function(e,t){this.baseUrl=e||"",this.options=t,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.side=this.options&&this.options.side?this.options.side:THREE.FrontSide,this.wrap=this.options&&this.options.wrap?this.options.wrap:THREE.RepeatWrapping},THREE.MTLLoader.MaterialCreator.prototype={constructor:THREE.MTLLoader.MaterialCreator,setCrossOrigin:function(e){this.crossOrigin=e},setManager:function(e){this.manager=e},setMaterials:function(e){this.materialsInfo=this.convert(e),this.materials={},this.materialsArray=[],this.nameLookup={}},convert:function(e){if(!this.options)return e;var t={};for(var r in e){var i=e[r],a={};t[r]=a;for(var s in i){var n=!0,o=i[s],c=s.toLowerCase();switch(c){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(o=[o[0]/255,o[1]/255,o[2]/255]),this.options&&this.options.ignoreZeroRGBs&&0===o[0]&&0===o[1]&&0===o[2]&&(n=!1)}n&&(a[c]=o)}}return t},preload:function(){for(var e in this.materialsInfo)this.create(e)},getIndex:function(e){return this.nameLookup[e]},getAsArray:function(){var e=0;for(var t in this.materialsInfo)this.materialsArray[e]=this.create(t),this.nameLookup[t]=e,e++;return this.materialsArray},create:function(e){return void 0===this.materials[e]&&this.createMaterial_(e),this.materials[e]},createMaterial_:function(e){function t(e,t){return"string"!=typeof t||""===t?"":/^https?:\/\//i.test(t)?t:e+t}function r(e,r){if(!s[e]){var a=i.getTextureParams(r,s),n=i.loadTexture(t(i.baseUrl,a.url));n.repeat.copy(a.scale),n.offset.copy(a.offset),n.wrapS=i.wrap,n.wrapT=i.wrap,s[e]=n}}var i=this,a=this.materialsInfo[e],s={name:e,side:this.side};for(var n in a){var o=a[n];if(""!==o)switch(n.toLowerCase()){case"kd":s.color=(new THREE.Color).fromArray(o);break;case"ks":s.specular=(new THREE.Color).fromArray(o);break;case"map_kd":r("map",o);break;case"map_ks":r("specularMap",o);break;case"map_bump":case"bump":r("bumpMap",o);break;case"ns":s.shininess=parseFloat(o);break;case"d":o<1&&(s.opacity=o,s.transparent=!0);break;case"Tr":o>0&&(s.opacity=1-o,s.transparent=!0)}}return this.materials[e]=new THREE.MeshPhongMaterial(s),this.materials[e]},getTextureParams:function(e,t){var r,i={scale:new THREE.Vector2(1,1),offset:new THREE.Vector2(0,0)},a=e.split(/\s+/);return(r=a.indexOf("-bm"))>=0&&(t.bumpScale=parseFloat(a[r+1]),a.splice(r,2)),(r=a.indexOf("-s"))>=0&&(i.scale.set(parseFloat(a[r+1]),parseFloat(a[r+2])),a.splice(r,4)),(r=a.indexOf("-o"))>=0&&(i.offset.set(parseFloat(a[r+1]),parseFloat(a[r+2])),a.splice(r,4)),i.url=a.join(" ").trim(),i},loadTexture:function(e,t,r,i,a){var s;if(altspace&&altspace.inClient)s=new THREE.Texture({src:e});else{var n=THREE.Loader.Handlers.get(e),o=void 0!==this.manager?this.manager:THREE.DefaultLoadingManager;null===n&&(n=new THREE.TextureLoader(o)),n.setCrossOrigin&&n.setCrossOrigin(this.crossOrigin),s=n.load(e,r,i,a)}return void 0!==t&&(s.mapping=t),s}},THREE.OBJLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.materials=null,this.regexp={vertex_pattern:/^v\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,normal_pattern:/^vn\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,uv_pattern:/^vt\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,face_vertex:/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_vertex_uv:/^f\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+))?/,face_vertex_uv_normal:/^f\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+)\/(-?\d+))?/,face_vertex_normal:/^f\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)(?:\s+(-?\d+)\/\/(-?\d+))?/,object_pattern:/^[og]\s*(.+)?/,smoothing_pattern:/^s\s+(\d+|on|off)/,material_library_pattern:/^mtllib /,material_use_pattern:/^usemtl /}},THREE.OBJLoader.prototype={constructor:THREE.OBJLoader,load:function(e,t,r,i){var a=this,s=new THREE.FileLoader(a.manager);s.setPath(this.path),s.load(e,function(e){t(a.parse(e))},r,i)},setPath:function(e){this.path=e},setMaterials:function(e){this.materials=e},_createParserState:function(){var e={objects:[],object:{},vertices:[],normals:[],uvs:[],materialLibraries:[],startObject:function(e,t){if(this.object&&!1===this.object.fromDeclaration)return this.object.name=e,void(this.object.fromDeclaration=!1!==t);var r=this.object&&"function"==typeof this.object.currentMaterial?this.object.currentMaterial():void 0;if(this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0),this.object={name:e||"",fromDeclaration:!1!==t,geometry:{vertices:[],normals:[],uvs:[]},materials:[],smooth:!0,startMaterial:function(e,t){var r=this._finalize(!1);r&&(r.inherited||r.groupCount<=0)&&this.materials.splice(r.index,1);var i={index:this.materials.length,name:e||"",mtllib:Array.isArray(t)&&t.length>0?t[t.length-1]:"",smooth:void 0!==r?r.smooth:this.smooth,groupStart:void 0!==r?r.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(e){var t={index:"number"==typeof e?e:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:0,groupEnd:-1,groupCount:-1,inherited:!1};return t.clone=this.clone.bind(t),t}};return this.materials.push(i),i},currentMaterial:function(){if(this.materials.length>0)return this.materials[this.materials.length-1]},_finalize:function(e){var t=this.currentMaterial();if(t&&-1===t.groupEnd&&(t.groupEnd=this.geometry.vertices.length/3,t.groupCount=t.groupEnd-t.groupStart,t.inherited=!1),e&&this.materials.length>1)for(var r=this.materials.length-1;r>=0;r--)this.materials[r].groupCount<=0&&this.materials.splice(r,1);return e&&0===this.materials.length&&this.materials.push({name:"",smooth:this.smooth}),t}},r&&r.name&&"function"==typeof r.clone){var i=r.clone(0);i.inherited=!0,this.object.materials.push(i)}this.objects.push(this.object)},finalize:function(){this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0)},parseVertexIndex:function(e,t){var r=parseInt(e,10);return 3*(r>=0?r-1:r+t/3)},parseNormalIndex:function(e,t){var r=parseInt(e,10);return 3*(r>=0?r-1:r+t/3)},parseUVIndex:function(e,t){var r=parseInt(e,10);return 2*(r>=0?r-1:r+t/2)},addVertex:function(e,t,r){var i=this.vertices,a=this.object.geometry.vertices;a.push(i[e+0]),a.push(i[e+1]),a.push(i[e+2]),a.push(i[t+0]),a.push(i[t+1]),a.push(i[t+2]),a.push(i[r+0]),a.push(i[r+1]),a.push(i[r+2])},addVertexLine:function(e){var t=this.vertices,r=this.object.geometry.vertices;r.push(t[e+0]),r.push(t[e+1]),r.push(t[e+2])},addNormal:function(e,t,r){var i=this.normals,a=this.object.geometry.normals;a.push(i[e+0]),a.push(i[e+1]),a.push(i[e+2]),a.push(i[t+0]),a.push(i[t+1]),a.push(i[t+2]),a.push(i[r+0]),a.push(i[r+1]),a.push(i[r+2])},addUV:function(e,t,r){var i=this.uvs,a=this.object.geometry.uvs;a.push(i[e+0]),a.push(i[e+1]),a.push(i[t+0]),a.push(i[t+1]),a.push(i[r+0]),a.push(i[r+1])},addUVLine:function(e){var t=this.uvs,r=this.object.geometry.uvs;r.push(t[e+0]),r.push(t[e+1])},addFace:function(e,t,r,i,a,s,n,o,c,h,l,u){var d,p=this.vertices.length,f=this.parseVertexIndex(e,p),m=this.parseVertexIndex(t,p),v=this.parseVertexIndex(r,p);if(void 0===i?this.addVertex(f,m,v):(d=this.parseVertexIndex(i,p),this.addVertex(f,m,d),this.addVertex(m,v,d)),void 0!==a){var E=this.uvs.length;f=this.parseUVIndex(a,E),m=this.parseUVIndex(s,E),v=this.parseUVIndex(n,E),void 0===i?this.addUV(f,m,v):(d=this.parseUVIndex(o,E),this.addUV(f,m,d),this.addUV(m,v,d))}if(void 0!==c){var g=this.normals.length;f=this.parseNormalIndex(c,g),m=c===h?f:this.parseNormalIndex(h,g),v=c===l?f:this.parseNormalIndex(l,g),void 0===i?this.addNormal(f,m,v):(d=this.parseNormalIndex(u,g),this.addNormal(f,m,d),this.addNormal(m,v,d))}},addLineGeometry:function(e,t){this.object.geometry.type="Line";for(var r=this.vertices.length,i=this.uvs.length,a=0,s=e.length;a<s;a++)this.addVertexLine(this.parseVertexIndex(e[a],r));for(var n=0,s=t.length;n<s;n++)this.addUVLine(this.parseUVIndex(t[n],i))}};return e.startObject("",!1),e},parse:function(e){console.time("OBJLoader");var t=this._createParserState();-1!==e.indexOf("\r\n")&&(e=e.replace(/\r\n/g,"\n")),-1!==e.indexOf("\\\n")&&(e=e.replace(/\\\n/g,""));for(var r=e.split("\n"),i="",a="",s="",n=[],o="function"==typeof"".trimLeft,c=0,h=r.length;c<h;c++)if(i=r[c],i=o?i.trimLeft():i.trim(),0!==i.length&&"#"!==(a=i.charAt(0)))if("v"===a)if(" "===(s=i.charAt(1))&&null!==(n=this.regexp.vertex_pattern.exec(i)))t.vertices.push(parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3]));else if("n"===s&&null!==(n=this.regexp.normal_pattern.exec(i)))t.normals.push(parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3]));else{if("t"!==s||null===(n=this.regexp.uv_pattern.exec(i)))throw new Error("Unexpected vertex/normal/uv line: '"+i+"'");t.uvs.push(parseFloat(n[1]),parseFloat(n[2]))}else if("f"===a)if(null!==(n=this.regexp.face_vertex_uv_normal.exec(i)))t.addFace(n[1],n[4],n[7],n[10],n[2],n[5],n[8],n[11],n[3],n[6],n[9],n[12]);else if(null!==(n=this.regexp.face_vertex_uv.exec(i)))t.addFace(n[1],n[3],n[5],n[7],n[2],n[4],n[6],n[8]);else if(null!==(n=this.regexp.face_vertex_normal.exec(i)))t.addFace(n[1],n[3],n[5],n[7],void 0,void 0,void 0,void 0,n[2],n[4],n[6],n[8]);else{if(null===(n=this.regexp.face_vertex.exec(i)))throw new Error("Unexpected face line: '"+i+"'");t.addFace(n[1],n[2],n[3],n[4])}else if("l"===a){var l=i.substring(1).trim().split(" "),u=[],d=[];if(-1===i.indexOf("/"))u=l;else for(var p=0,f=l.length;p<f;p++){var m=l[p].split("/");""!==m[0]&&u.push(m[0]),""!==m[1]&&d.push(m[1])}t.addLineGeometry(u,d)}else if(null!==(n=this.regexp.object_pattern.exec(i))){var v=(" "+n[0].substr(1).trim()).substr(1);t.startObject(v)}else if(this.regexp.material_use_pattern.test(i))t.object.startMaterial(i.substring(7).trim(),t.materialLibraries);else if(this.regexp.material_library_pattern.test(i))t.materialLibraries.push(i.substring(7).trim());else{if(null===(n=this.regexp.smoothing_pattern.exec(i))){if("\0"===i)continue;throw new Error("Unexpected line: '"+i+"'")}var E=n[1].trim().toLowerCase();t.object.smooth="1"===E||"on"===E,(M=t.object.currentMaterial())&&(M.smooth=t.object.smooth)}t.finalize();var g=new THREE.Group;g.materialLibraries=[].concat(t.materialLibraries);for(var c=0,h=t.objects.length;c<h;c++){var T=t.objects[c],y=T.geometry,b=T.materials,R="Line"===y.type;if(0!==y.vertices.length){var w=new THREE.BufferGeometry;w.addAttribute("position",new THREE.BufferAttribute(new Float32Array(y.vertices),3)),y.normals.length>0?w.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(y.normals),3)):w.computeVertexNormals(),y.uvs.length>0&&w.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(y.uvs),2));for(var x=[],H=0,N=b.length;H<N;H++){var A=b[H],M=void 0;if(null!==this.materials&&(M=this.materials.create(A.name),R&&M&&!(M instanceof THREE.LineBasicMaterial))){var L=new THREE.LineBasicMaterial;L.copy(M),M=L}M||((M=R?new THREE.LineBasicMaterial:new THREE.MeshPhongMaterial).name=A.name),M.shading=A.smooth?THREE.SmoothShading:THREE.FlatShading,x.push(M)}var k;if(x.length>1){for(var H=0,N=b.length;H<N;H++){A=b[H];w.addGroup(A.groupStart,A.groupCount,H)}var _=new THREE.MultiMaterial(x);k=R?new THREE.LineSegments(w,_):new THREE.Mesh(w,_)}else k=R?new THREE.LineSegments(w,x[0]):new THREE.Mesh(w,x[0]);k.name=T.name,g.add(k)}}return console.log("------------ UltimateLoader ---------------"),console.timeEnd("OBJLoader"),g}},THREE.ColladaLoader=function(){function e(e,n,o){if(console.time("ColladaLoader"),je=(new DOMParser).parseFromString(e,"text/xml"),n=n||Fe,void 0!==o){var c=o.split("/");c.pop(),Oe=(c.length<1?".":c.join("/"))+"/"}t(),Te(),Ue=r("library_images image",x,"image"),Pe=r("library_materials material",q,"material"),qe=r("library_effects effect",K,"effect"),Ge=r("library_geometries geometry",C,"geometry"),Ye=r("library_cameras camera",te,"camera"),Xe=r("library_lights light",ie,"light"),Be=r("library_controllers controller",H,"controller"),Ve=r("library_animations animation",J,"animation"),ke=r("library_visual_scenes visual_scene",M,"visual_scene"),_e=r("library_kinematics_models kinematics_model",se,"kinematics_model"),Se=[],Ce=[],Ne=i(),Ie=new THREE.Group;for(var h=0;h<Ne.nodes.length;h++)Ie.add(m(Ne.nodes[h]));Ie.scale.multiplyScalar(Ke),s(),Ae=a(),f();var l={scene:Ie,morphs:Se,skins:Ce,animations:Me,kinematics:Le,dae:{images:Ue,materials:Pe,cameras:Ye,lights:Xe,effects:qe,geometries:Ge,controllers:Be,animations:Ve,visualScenes:ke,visualScene:Ne,scene:Ne,kinematicsModels:_e,kinematicsModel:Ae}};return console.log("------------ UltimateLoader ---------------"),console.timeEnd("ColladaLoader"),n&&n(l),l}function t(){var e=je.querySelectorAll("asset")[0];if(e&&e.childNodes)for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"unit":var i=r.getAttribute("meter");i&&(Ke=parseFloat(i));break;case"up_axis":Ze=r.textContent.charAt(0)}}}function r(e,t,r){for(var i=je.querySelectorAll(e),a={},s=0,n=i.length,o=0;o<n;o++){var c=i[o],h=(new t).parse(c);h.id&&0!==h.id.length||(h.id=r+s++),a[h.id]=h}return a}function i(){var e=je.querySelectorAll("scene instance_visual_scene")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return ke[t.length>0?t:"visual_scene0"]}return null}function a(){var e=je.querySelectorAll("instance_kinematics_model")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return _e[t.length>0?t:"kinematics_model0"]}return null}function s(){Me=[],n(Ie)}function n(e){var t=Ne.getChildById(e.colladaId,!0),r=null;if(t&&t.keys){r={fps:60,hierarchy:[{node:t,keys:t.keys,sids:t.sids}],node:e,name:"animation_"+e.name,length:0},Me.push(r);for(var i=0,a=t.keys.length;i<a;i++)r.length=Math.max(r.length,t.keys[i].time)}else r={hierarchy:[{keys:[],sids:[]}]};for(var i=0,a=e.children.length;i<a;i++)for(var s=0,o=n(e.children[i]).hierarchy.length;s<o;s++)r.hierarchy.push({keys:[],sids:[]});return r}function o(){var e,t=1e6,r=-t,i=0;for(var a in Ve){var s=Ve[a];e=e||s.id;for(var n=0;n<s.sampler.length;n++){var o=s.sampler[n];o.create(),t=Math.min(t,o.startTime),r=Math.max(r,o.endTime),i=Math.max(i,o.input.length)}}return{start:t,end:r,frames:i,ID:e}}function c(e,t){var r=t instanceof _?Be[t.url]:t;if(r&&r.morph){for(var i=r.morph,a=0;a<i.targets.length;a++){var s=i.targets[a],n=Ge[s];if(n.mesh&&n.mesh.primitives&&n.mesh.primitives.length){var o=n.mesh.primitives[0].geometry;o.vertices.length===e.vertices.length&&e.morphTargets.push({name:"target_1",vertices:o.vertices})}}e.morphTargets.push({name:"target_Z",vertices:e.vertices})}else console.log("could not find morph controller!")}function h(e,t,r,i){if(e.world=e.world||new THREE.Matrix4,e.localworld=e.localworld||new THREE.Matrix4,e.world.copy(e.matrix),e.localworld.copy(e.matrix),e.channels&&e.channels.length){var a=e.channels[0].sampler.output[r];a instanceof THREE.Matrix4&&(e.world.copy(a),e.localworld.copy(a),0===r&&e.matrix.copy(a))}i&&e.world.multiplyMatrices(i,e.world),t.push(e);for(var s=0;s<e.nodes.length;s++)h(e.nodes[s],t,r,e.world)}function l(e,t){for(var r=0;r<e.length;r++){var i=e[r],a=-1;if("JOINT"==i.type){for(n=0;n<t.joints.length;n++)if(i.sid===t.joints[n]){a=n;break}if(a>=0){var s=t.invBindMatrices[a];i.invBindMatrix=s,i.skinningMatrix=new THREE.Matrix4,i.skinningMatrix.multiplyMatrices(i.world,s),i.animatrix=new THREE.Matrix4,i.animatrix.copy(i.localworld),i.weights=[];for(var n=0;n<t.weights.length;n++)for(var o=0;o<t.weights[n].length;o++){var c=t.weights[n][o];c.joint===a&&i.weights.push(c)}}else console.warn("ColladaLoader: Could not find joint '"+i.sid+"'."),i.skinningMatrix=new THREE.Matrix4,i.weights=[]}}}function u(e){var t=[],r=function(e,t,i){var a={};a.name=t.sid,a.parent=e,a.matrix=t.matrix;var s=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];a.matrix.decompose(s[0],s[1],s[2]),a.pos=[s[0].x,s[0].y,s[0].z],a.scl=[s[2].x,s[2].y,s[2].z],a.rotq=[s[1].x,s[1].y,s[1].z,s[1].w],i.push(a);for(var n in t.nodes)r(t.sid,t.nodes[n],i)};return r(-1,e,t),t}function d(e,t,r){var i=[];h(t,i,-1),l(i,r.skin);for(var a=new THREE.Vector3,s=[],n=0;n<e.vertices.length;n++)s.push(new THREE.Vector3);for(n=0;n<i.length;n++)if("JOINT"==i[n].type)for(var o=0;o<i[n].weights.length;o++){var c=i[n].weights[o],u=c.index,d=c.weight,p=e.vertices[u],f=s[u];a.x=p.x,a.y=p.y,a.z=p.z,a.applyMatrix4(i[n].skinningMatrix),f.x+=a.x*d,f.y+=a.y*d,f.z+=a.z*d}for(n=0;n<e.vertices.length;n++)e.vertices[n]=s[n]}function p(e,t,r){var i=Be[t.url];if(r=void 0!==r?r:40,i&&i.skin)if(t.skeleton&&t.skeleton.length){for(var a=o(),s=Ne.getChildById(t.skeleton[0],!0)||Ne.getChildBySid(t.skeleton[0],!0),n=u(s),c=i.skin.joints,p=[],f=0;f<c.length;f++)for(b=0;b<n.length;b++)n[b].name===c[f]&&(p[f]=n[b]);for(f=0;f<p.length;f++)for(b=0;b<p.length;b++)p[f].parent===p[b].name&&(p[f].parent=b);new THREE.Vector3;for(f=0;f<e.vertices.length;f++)e.vertices[f].applyMatrix4(i.skin.bindShapeMatrix);for(var m=[],v=[],E=i.skin.weights,f=0;f<E.length;f++){var g=new THREE.Vector4(E[f][0]?E[f][0].joint:0,E[f][1]?E[f][1].joint:0,E[f][2]?E[f][2].joint:0,E[f][3]?E[f][3].joint:0),T=new THREE.Vector4(E[f][0]?E[f][0].weight:0,E[f][1]?E[f][1].weight:0,E[f][2]?E[f][2].weight:0,E[f][3]?E[f][3].weight:0);m.push(g),v.push(T)}e.skinIndices=m,e.skinWeights=v,e.bones=p;for(var y={name:a.ID,fps:30,length:a.frames/30,hierarchy:[]},b=0;b<p.length;b++)y.hierarchy.push({parent:p[b].parent,name:p[b].name,keys:[]});for(console.log("ColladaLoader:",a.ID+" has "+p.length+" bones."),d(e,s,i),r=0;r<a.frames;r++){var R=[];h(s,R,r),l(R,i.skin);for(f=0;f<R.length;f++)for(b=0;b<y.hierarchy.length;b++)if(y.hierarchy[b].name===R[f].sid){var w={};w.time=r/30,w.matrix=R[f].animatrix,0===r&&(R[f].matrix=w.matrix);var x=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];w.matrix.decompose(x[0],x[1],x[2]),w.pos=[x[0].x,x[0].y,x[0].z],w.scl=[x[2].x,x[2].y,x[2].z],w.rot=x[1],y.hierarchy[b].keys.push(w)}e.animation=y}}else console.log("ColladaLoader: Could not find the skeleton for the skin. ");else console.log("ColladaLoader: Could not find skin controller.")}function f(){if(Ae&&0===Ae.joints.length)Le=void 0;else{var e={};Le={joints:Ae&&Ae.joints,getJointValue:function(t){var r=e[t];if(r)return r.position;console.log("getJointValue: joint "+t+" doesn't exist")},setJointValue:function(t,i){var a=e[t];if(a){var s=a.joint;if(i>s.limits.max||i<s.limits.min)console.log("setJointValue: joint "+t+" value "+i+" outside of limits (min: "+s.limits.min+", max: "+s.limits.max+")");else if(s.static)console.log("setJointValue: joint "+t+" is static");else{var n=a.node,o=s.axis,c=a.transforms,h=new THREE.Matrix4;for(r=0;r<c.length;r++){var l=c[r];if(l.sid&&-1!==l.sid.indexOf("joint"+t))switch(s.type){case"revolute":h.multiply(u.makeRotationAxis(o,THREE.Math.degToRad(i)));break;case"prismatic":h.multiply(u.makeTranslation(o.x*i,o.y*i,o.z*i));break;default:console.warn("setJointValue: unknown joint type: "+s.type)}else{var u=new THREE.Matrix4;switch(l.type){case"matrix":h.multiply(l.obj);break;case"translate":h.multiply(u.makeTranslation(l.obj.x,l.obj.y,l.obj.z));break;case"rotate":h.multiply(u.makeRotationAxis(l.obj,l.angle))}}}var d=h.elements,p=Array.prototype.slice.call(d),f=[p[0],p[4],p[8],p[12],p[1],p[5],p[9],p[13],p[2],p[6],p[10],p[14],p[3],p[7],p[11],p[15]];n.matrix.set.apply(n.matrix,f),n.matrix.decompose(n.position,n.quaternion,n.scale)}}else console.log("setJointValue: joint "+t+" doesn't exist")}};var t=je.querySelector("scene instance_kinematics_scene");if(t)for(var r=0;r<t.childNodes.length;r++){var i=t.childNodes[r];if(1==i.nodeType)switch(i.nodeName){case"bind_joint_axis":var a=i.getAttribute("target").split("/").pop(),s=i.querySelector("axis param").textContent,n=parseInt(s.split("joint").pop().split(".")[0]),o=je.querySelector('[sid="'+a+'"]');o&&function(t,r){var i=r.getAttribute("id"),a=Ne.getChildById(i,!0),s=Ae.joints[t];Ie.traverse(function(r){r.colladaId==i&&(e[t]={node:r,transforms:a.transforms,joint:s,position:s.zeroPosition})})}(n,o.parentElement)}}}}function m(e,t){var r,i,a,s,n=new THREE.Object3D;for(a=0;a<e.controllers.length;a++){var o=Be[e.controllers[a].url];switch(o.type){case"skin":if(Ge[o.skin.source])(l=new S).url=o.skin.source,l.instance_material=e.controllers[a].instance_material,e.geometries.push(l),!0,r=e.controllers[a];else if(Be[o.skin.source]){var h=Be[o.skin.source];i=h,h.morph&&Ge[h.morph.source]&&((l=new S).url=h.morph.source,l.instance_material=e.controllers[a].instance_material,e.geometries.push(l))}break;case"morph":if(Ge[o.morph.source]){var l=new S;l.url=o.morph.source,l.instance_material=e.controllers[a].instance_material,e.geometries.push(l),i=e.controllers[a]}console.log("ColladaLoader: Morph-controller partially supported.")}}var u={};for(a=0;a<e.geometries.length;a++){var d,f=e.geometries[a],v=f.instance_material,E=Ge[f.url],g={},T=[],y=0;if(E){if(!E.mesh||!E.mesh.primitives)continue;if(0===n.name.length&&(n.name=E.id),v)for(s=0;s<v.length;s++){var b=v[s],R=Pe[b.target],w=R.instance_effect.url,x=qe[w].shader.material;if(E.doubleSided){if(!(b.symbol in u)){var H=x.clone();H.side=THREE.DoubleSide,u[b.symbol]=H}x=u[b.symbol]}x.opacity=x.opacity?x.opacity:1,g[b.symbol]=y,T.push(x),(d=x).name=null===R.name||""===R.name?R.id:R.name,y++}var N,A=d||new THREE.MeshLambertMaterial({color:14540253,side:E.doubleSided?THREE.DoubleSide:THREE.FrontSide}),M=E.mesh.geometry3js;if(y>1)for(A=new THREE.MultiMaterial(T),s=0;s<M.faces.length;s++){var L=M.faces[s];L.materialIndex=g[L.daeMaterial]}void 0!==r?(p(M,r),M.morphTargets.length>0?(A.morphTargets=!0,A.skinning=!1):(A.morphTargets=!1,A.skinning=!0),(N=new THREE.SkinnedMesh(M,A,!1)).name="skin_"+Ce.length,Ce.push(N)):void 0!==i?(c(M,i),A.morphTargets=!0,(N=new THREE.Mesh(M,A)).name="morph_"+Se.length,Se.push(N)):N=!0===M.isLineStrip?new THREE.Line(M):new THREE.Mesh(M,A),n.add(N)}}for(a=0;a<e.cameras.length;a++){var k=e.cameras[a],_=Ye[k.url],O=new THREE.PerspectiveCamera(_.yfov,parseFloat(_.aspect_ratio),parseFloat(_.znear),parseFloat(_.zfar));n.add(O)}for(a=0;a<e.lights.length;a++){var C=null,j=e.lights[a],I=Xe[j.url];if(I&&I.technique){var F=I.color.getHex(),D=I.intensity,U=I.distance,V=I.falloff_angle;switch(I.technique){case"directional":(C=new THREE.DirectionalLight(F,D,U)).position.set(0,0,1);break;case"point":C=new THREE.PointLight(F,D,U);break;case"spot":(C=new THREE.SpotLight(F,D,U,V)).position.set(0,0,1);break;case"ambient":C=new THREE.AmbientLight(F)}}C&&n.add(C)}if(n.name=e.name||e.id||"",n.colladaId=e.id||"",n.layer=e.layer||"",n.matrix=e.matrix,n.matrix.decompose(n.position,n.quaternion,n.scale),ze.centerGeometry&&n.geometry){var B=n.geometry.center();B.multiply(n.scale),B.applyQuaternion(n.quaternion),n.position.sub(B)}for(a=0;a<e.nodes.length;a++)n.add(m(e.nodes[a],e));return n}function v(e){for(var t=je.querySelectorAll("library_nodes node"),r=0;r<t.length;r++){var i=t[r].attributes.getNamedItem("id");if(i&&i.value===e)return t[r]}}function E(e){var t=[],r=1e6,i=-1e6;for(var a in Ve)for(var s=Ve[a],n=0;n<s.channel.length;n++){var o=s.channel[n],c=s.sampler[n];(a=o.target.split("/")[0])==e.id&&(c.create(),o.sampler=c,r=Math.min(r,c.startTime),i=Math.max(i,c.endTime),t.push(o))}return t.length&&(e.startTime=r,e.endTime=i),t}function g(e){if(e.channels&&e.channels.length){for(var t=[],r=[],i=0,a=e.channels.length;i<a;i++){var s,n=e.channels[i],o=n.fullSid,c=n.sampler,h=c.input,l=e.getTransformBySid(n.sid);if(n.arrIndices){s=[];for(var u=0,d=n.arrIndices.length;u<d;u++)s[u]=xe(n.arrIndices[u])}else s=He(n.member);if(l){-1===r.indexOf(o)&&r.push(o);for(var u=0,d=h.length;u<d;u++){var p=h[u],f=c.getData(l.type,u,s);if(!(E=T(t,p))){E=new ee(p);var m=y(t,p);t.splice(-1===m?t.length:m,0,E)}E.addTarget(o,l,s,f)}}else console.log('Could not find transform "'+n.sid+'" in node '+e.id)}for(i=0;i<r.length;i++)for(var v=r[i],u=0;u<t.length;u++){var E=t[u];E.hasTarget(v)||b(t,E,u,v)}e.keys=t,e.sids=r}}function T(e,t){for(var r=null,i=0,a=e.length;i<a&&null===r;i++){var s=e[i];if(s.time===t)r=s;else if(s.time>t)break}return r}function y(e,t){for(var r=-1,i=0,a=e.length;i<a&&-1===r;i++)e[i].time>=t&&(r=i);return r}function b(e,t,r,i){var a=w(e,i,r?r-1:0),s=R(e,i,r+1);if(a&&s){var n,o=(t.time-a.time)/(s.time-a.time),c=a.getTarget(i),h=s.getTarget(i).data,l=c.data;if("matrix"===c.type)n=l;else if(l.length){n=[];for(var u=0;u<l.length;++u)n[u]=l[u]+(h[u]-l[u])*o}else n=l+(h-l)*o;t.addTarget(i,c.transform,c.member,n)}}function R(e,t,r){for(;r<e.length;r++){var i=e[r];if(i.hasTarget(t))return i}return null}function w(e,t,r){for(r=r>=0?r:r+e.length;r>=0;r--){var i=e[r];if(i.hasTarget(t))return i}return null}function x(){this.id="",this.init_from=""}function H(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function N(){this.method=null,this.source=null,this.targets=null,this.weights=null}function A(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function M(){this.id="",this.name="",this.nodes=[],this.scene=new THREE.Group}function L(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE.Matrix4}function k(){this.sid="",this.type="",this.data=[],this.obj=null}function _(){this.url="",this.skeleton=[],this.instance_material=[]}function O(){this.symbol="",this.target=""}function S(){this.url="",this.instance_material=[]}function C(){this.id="",this.mesh=null}function j(e){this.geometry=e.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function I(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE.Geometry}function F(){I.call(this),this.vcount=[]}function D(){I.call(this),this.vcount=1}function U(){I.call(this),this.vcount=3}function V(){this.source="",this.count=0,this.stride=0,this.params=[]}function B(){this.input={}}function G(){this.semantic="",this.offset=0,this.source="",this.set=0}function P(e){this.id=e,this.type=null}function q(){this.id="",this.name="",this.instance_effect=null}function Y(){this.color=new THREE.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function X(e,t){this.type=e,this.effect=t,this.material=null}function W(e){this.effect=e,this.init_from=null,this.format=null}function z(e){this.effect=e,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function K(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function Z(){this.url=""}function J(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function Q(e){this.animation=e,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function $(e){this.id="",this.animation=e,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function ee(e){this.targets=[],this.time=e}function te(){this.id="",this.name="",this.technique=""}function re(){this.url=""}function ie(){this.id="",this.name="",this.technique=""}function ae(){this.url=""}function se(){this.id="",this.name="",this.joints=[],this.links=[]}function ne(){this.sid="",this.name="",this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0}function oe(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function ce(){this.joint="",this.transforms=[],this.links=[]}function he(e){var t=e.getAttribute("id");return void 0!=De[t]?De[t]:(De[t]=new P(t).parse(e),De[t])}function le(e){for(var t=pe(e),r=[],i=0,a=t.length;i<a;i++)r.push("true"===t[i]||"1"===t[i]);return r}function ue(e){for(var t=pe(e),r=[],i=0,a=t.length;i<a;i++)r.push(parseFloat(t[i]));return r}function de(e){for(var t=pe(e),r=[],i=0,a=t.length;i<a;i++)r.push(parseInt(t[i],10));return r}function pe(e){return e.length>0?fe(e).split(/\s+/):[]}function fe(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}function me(e,t,r){return e.hasAttribute(t)?parseInt(e.getAttribute(t),10):r}function ve(e,t){return"string"!=typeof e||""===e?"":/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:new URL((t||"")+e,location.href.substring(0,location.href.lastIndexOf("/")+1)).toString()}function Ee(e,t){(new THREE.ImageLoader).load(t,function(t){e.image=t,e.needsUpdate=!0})}function ge(e,t){e.doubleSided=!1;var r=t.querySelectorAll("extra double_sided")[0];r&&r&&1===parseInt(r.textContent,10)&&(e.doubleSided=!0)}function Te(){if(!0!==ze.convertUpAxis||Ze===ze.upAxis)Je=null;else switch(Ze){case"X":Je="Y"===ze.upAxis?"XtoY":"XtoZ";break;case"Y":Je="X"===ze.upAxis?"YtoX":"YtoZ";break;case"Z":Je="X"===ze.upAxis?"ZtoX":"ZtoY"}}function ye(e,t){if(!0===ze.convertUpAxis&&Ze!==ze.upAxis)switch(Je){case"XtoY":r=e[0];e[0]=t*e[1],e[1]=r;break;case"XtoZ":r=e[2];e[2]=e[1],e[1]=e[0],e[0]=r;break;case"YtoX":r=e[0];e[0]=e[1],e[1]=t*r;break;case"YtoZ":r=e[1];e[1]=t*e[2],e[2]=r;break;case"ZtoX":r=e[0];e[0]=e[1],e[1]=e[2],e[2]=r;break;case"ZtoY":var r=e[1];e[1]=e[2],e[2]=t*r}}function be(e,t){if(!0!==ze.convertUpAxis||Ze===ze.upAxis)return t;switch(e){case"X":t="XtoY"===Je?-1*t:t;break;case"Y":t="YtoZ"===Je||"YtoX"===Je?-1*t:t;break;case"Z":t="ZtoY"===Je?-1*t:t}return t}function Re(e,t){var r=[e[t],e[t+1],e[t+2]];return ye(r,-1),new THREE.Vector3(r[0],r[1],r[2])}function we(e){if(ze.convertUpAxis){var t=[e[0],e[4],e[8]];ye(t,-1),e[0]=t[0],e[4]=t[1],e[8]=t[2],ye(t=[e[1],e[5],e[9]],-1),e[1]=t[0],e[5]=t[1],e[9]=t[2],ye(t=[e[2],e[6],e[10]],-1),e[2]=t[0],e[6]=t[1],e[10]=t[2],ye(t=[e[0],e[1],e[2]],-1),e[0]=t[0],e[1]=t[1],e[2]=t[2],ye(t=[e[4],e[5],e[6]],-1),e[4]=t[0],e[5]=t[1],e[6]=t[2],ye(t=[e[8],e[9],e[10]],-1),e[8]=t[0],e[9]=t[1],e[10]=t[2],ye(t=[e[3],e[7],e[11]],-1),e[3]=t[0],e[7]=t[1],e[11]=t[2]}return(new THREE.Matrix4).set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function xe(e){return e>-1&&e<3&&(e={X:0,Y:1,Z:2}[e=He(["X","Y","Z"][e])]),e}function He(e){if(ze.convertUpAxis)switch(e){case"X":switch(Je){case"XtoY":case"XtoZ":case"YtoX":e="Y";break;case"ZtoX":e="Z"}break;case"Y":switch(Je){case"XtoY":case"YtoX":case"ZtoX":e="X";break;case"XtoZ":case"YtoZ":case"ZtoY":e="Z"}break;case"Z":switch(Je){case"XtoZ":e="X";break;case"YtoZ":case"ZtoX":case"ZtoY":e="Y"}}return e}var Ne,Ae,Me,Le,ke,_e,Oe,Se,Ce,je=null,Ie=null,Fe=null,De={},Ue={},Ve={},Be={},Ge={},Pe={},qe={},Ye={},Xe={},We=THREE.SmoothShading,ze={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null},Ke=1,Ze="Y",Je=null;return x.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];"init_from"===r.nodeName&&(this.init_from=r.textContent)}return this},H.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.type="none";for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"skin":this.skin=(new A).parse(r),this.type=r.nodeName;break;case"morph":this.morph=(new N).parse(r),this.type=r.nodeName}}return this},N.prototype.parse=function(e){var t,r={},i=[];for(this.method=e.getAttribute("method"),this.source=e.getAttribute("source").replace(/^#/,""),t=0;t<e.childNodes.length;t++){var a=e.childNodes[t];if(1==a.nodeType)switch(a.nodeName){case"source":r[(n=(new P).parse(a)).id]=n;break;case"targets":i=this.parseInputs(a);break;default:console.log(a.nodeName)}}for(t=0;t<i.length;t++){var s=i[t],n=r[s.source];switch(s.semantic){case"MORPH_TARGET":this.targets=n.read();break;case"MORPH_WEIGHT":this.weights=n.read()}}return this},N.prototype.parseInputs=function(e){for(var t=[],r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(1==i.nodeType)switch(i.nodeName){case"input":t.push((new G).parse(i))}}return t},A.prototype.parse=function(e){var t,r,i={};this.source=e.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var a=0;a<e.childNodes.length;a++){var s=e.childNodes[a];if(1==s.nodeType)switch(s.nodeName){case"bind_shape_matrix":var n=ue(s.textContent);this.bindShapeMatrix=we(n);break;case"source":var o=(new P).parse(s);i[o.id]=o;break;case"joints":t=s;break;case"vertex_weights":r=s;break;default:console.log(s.nodeName)}}return this.parseJoints(t,i),this.parseWeights(r,i),this},A.prototype.parseJoints=function(e,t){for(var r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(1==i.nodeType)switch(i.nodeName){case"input":var a=(new G).parse(i),s=t[a.source];"JOINT"===a.semantic?this.joints=s.read():"INV_BIND_MATRIX"===a.semantic&&(this.invBindMatrices=s.read())}}},A.prototype.parseWeights=function(e,t){for(var r,i,a=[],s=0;s<e.childNodes.length;s++){var n=e.childNodes[s];if(1==n.nodeType)switch(n.nodeName){case"input":a.push((new G).parse(n));break;case"v":r=de(n.textContent);break;case"vcount":i=de(n.textContent)}}for(var o=0,s=0;s<i.length;s++){for(var c=i[s],h=[],l=0;l<c;l++){for(var u={},d=0;d<a.length;d++){var p=a[d],f=r[o+p.offset];switch(p.semantic){case"JOINT":u.joint=f;break;case"WEIGHT":u.weight=t[p.source].data[f]}}h.push(u),o+=a.length}for(l=0;l<h.length;l++)h[l].index=s;this.weights.push(h)}},M.prototype.getChildById=function(e,t){for(var r=0;r<this.nodes.length;r++){var i=this.nodes[r].getChildById(e,t);if(i)return i}return null},M.prototype.getChildBySid=function(e,t){for(var r=0;r<this.nodes.length;r++){var i=this.nodes[r].getChildBySid(e,t);if(i)return i}return null},M.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.nodes=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"node":this.nodes.push((new L).parse(r))}}return this},L.prototype.getChannelForTransform=function(e){for(var t=0;t<this.channels.length;t++){var r,i=this.channels[t],a=i.target.split("/"),s=(a.shift(),a.shift()),n=s.indexOf(".")>=0,o=s.indexOf("(")>=0;if(n)s=(a=s.split(".")).shift(),a.shift();else if(o){s=(r=s.split("(")).shift();for(var c=0;c<r.length;c++)r[c]=parseInt(r[c].replace(/\)/,""))}if(s===e)return i.info={sid:s,dotSyntax:n,arrSyntax:o,arrIndices:r},i}return null},L.prototype.getChildById=function(e,t){if(this.id===e)return this;if(t)for(var r=0;r<this.nodes.length;r++){var i=this.nodes[r].getChildById(e,t);if(i)return i}return null},L.prototype.getChildBySid=function(e,t){if(this.sid===e)return this;if(t)for(var r=0;r<this.nodes.length;r++){var i=this.nodes[r].getChildBySid(e,t);if(i)return i}return null},L.prototype.getTransformBySid=function(e){for(var t=0;t<this.transforms.length;t++)if(this.transforms[t].sid===e)return this.transforms[t];return null},L.prototype.parse=function(e){var t;this.id=e.getAttribute("id"),this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.type=e.getAttribute("type"),this.layer=e.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE.Matrix4;for(var r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(1==i.nodeType)switch(i.nodeName){case"node":this.nodes.push((new L).parse(i));break;case"instance_camera":this.cameras.push((new re).parse(i));break;case"instance_controller":this.controllers.push((new _).parse(i));break;case"instance_geometry":this.geometries.push((new S).parse(i));break;case"instance_light":this.lights.push((new ae).parse(i));break;case"instance_node":var a=v(t=i.getAttribute("url").replace(/^#/,""));a&&this.nodes.push((new L).parse(a));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new k).parse(i));break;case"extra":break;default:console.log(i.nodeName)}}return this.channels=E(this),g(this),this.updateMatrix(),this},L.prototype.updateMatrix=function(){this.matrix.identity();for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},k.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=ue(e.textContent),this.convert(),this},k.prototype.convert=function(){switch(this.type){case"matrix":this.obj=we(this.data);break;case"rotate":this.angle=THREE.Math.degToRad(this.data[3]);case"translate":ye(this.data,-1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":ye(this.data,1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},k.prototype.apply=function(){var e=new THREE.Matrix4;return function(t){switch(this.type){case"matrix":t.multiply(this.obj);break;case"translate":t.multiply(e.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":t.multiply(e.makeRotationAxis(this.obj,this.angle));break;case"scale":t.scale(this.obj)}}}(),k.prototype.update=function(e,t){var r=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(t)if(1===t.length)switch(t[0]){case 0:this.obj.n11=e[0],this.obj.n21=e[1],this.obj.n31=e[2],this.obj.n41=e[3];break;case 1:this.obj.n12=e[0],this.obj.n22=e[1],this.obj.n32=e[2],this.obj.n42=e[3];break;case 2:this.obj.n13=e[0],this.obj.n23=e[1],this.obj.n33=e[2],this.obj.n43=e[3];break;case 3:this.obj.n14=e[0],this.obj.n24=e[1],this.obj.n34=e[2],this.obj.n44=e[3]}else if(2===t.length){var i="n"+(t[0]+1)+(t[1]+1);this.obj[i]=e}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(e);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=r[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=r[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;case"ANGLE":this.angle=THREE.Math.degToRad(e);break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2],this.angle=THREE.Math.degToRad(e[3])}}},_.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1===r.nodeType)switch(r.nodeName){case"skeleton":this.skeleton.push(r.textContent.replace(/^#/,""));break;case"bind_material":for(var i=r.querySelectorAll("instance_material"),a=0;a<i.length;a++){var s=i[a];this.instance_material.push((new O).parse(s))}}}return this},O.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},S.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType&&"bind_material"===r.nodeName){for(var i=r.querySelectorAll("instance_material"),a=0;a<i.length;a++){var s=i[a];this.instance_material.push((new O).parse(s))}break}}return this},C.prototype.parse=function(e){this.id=e.getAttribute("id"),ge(this,e);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"mesh":this.mesh=new j(this).parse(r)}}return this},j.prototype.parse=function(e){this.primitives=[];for(i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];switch(t.nodeName){case"source":he(t);break;case"vertices":this.vertices=(new B).parse(t);break;case"linestrips":this.primitives.push((new D).parse(t));break;case"triangles":this.primitives.push((new U).parse(t));break;case"polygons":this.primitives.push((new I).parse(t));break;case"polylist":this.primitives.push((new F).parse(t))}}if(this.geometry3js=new THREE.Geometry,null===this.vertices)return this;for(var r=De[this.vertices.input.POSITION.source].data,i=0;i<r.length;i+=3)this.geometry3js.vertices.push(Re(r,i).clone());for(i=0;i<this.primitives.length;i++){var a=this.primitives[i];a.setVertices(this.vertices),this.handlePrimitive(a,this.geometry3js)}return this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this},j.prototype.handlePrimitive=function(e,t){if(e instanceof D)t.isLineStrip=!0;else{var r,i,a,s,n,o,c,h=e.p,l=e.inputs,u=0,d=3,p=0,f=[];for(r=0;r<l.length;r++){var m=(a=l[r]).offset+1;switch(p=p<m?m:p,a.semantic){case"TEXCOORD":f.push(a.set)}}for(var v=0;v<h.length;++v)for(var E=h[v],g=0;g<E.length;){var T=[],y=[],b=null,R=[];for(d=e.vcount?e.vcount.length?e.vcount[u++]:e.vcount:E.length/p,r=0;r<d;r++)for(i=0;i<l.length;i++)switch(a=l[i],o=De[a.source],s=E[g+r*p+a.offset],c=o.accessor.params.length,n=s*c,a.semantic){case"VERTEX":T.push(s);break;case"NORMAL":y.push(Re(o.data,n));break;case"TEXCOORD":void 0===(b=b||{})[a.set]&&(b[a.set]=[]),b[a.set].push(new THREE.Vector2(o.data[n],o.data[n+1]));break;case"COLOR":R.push((new THREE.Color).setRGB(o.data[n],o.data[n+1],o.data[n+2]))}if(0===y.length)if(a=this.vertices.input.NORMAL){c=(o=De[a.source]).accessor.params.length;for(var w=0,x=T.length;w<x;w++)y.push(Re(o.data,T[w]*c))}else t.calcNormals=!0;if(!b&&(b={},a=this.vertices.input.TEXCOORD)){f.push(a.set),c=(o=De[a.source]).accessor.params.length;for(var w=0,x=T.length;w<x;w++)n=T[w]*c,void 0===b[a.set]&&(b[a.set]=[]),b[a.set].push(new THREE.Vector2(o.data[n],1-o.data[n+1]))}if(0===R.length&&(a=this.vertices.input.COLOR)){c=(o=De[a.source]).accessor.params.length;for(var w=0,x=T.length;w<x;w++)n=T[w]*c,R.push((new THREE.Color).setRGB(o.data[n],o.data[n+1],o.data[n+2]))}var H,N,A=null,M=[];if(3===d)M.push(new THREE.Face3(T[0],T[1],T[2],y,R.length?R:new THREE.Color));else if(4===d)M.push(new THREE.Face3(T[0],T[1],T[3],y.length?[y[0].clone(),y[1].clone(),y[3].clone()]:[],R.length?[R[0],R[1],R[3]]:new THREE.Color)),M.push(new THREE.Face3(T[1],T[2],T[3],y.length?[y[1].clone(),y[2].clone(),y[3].clone()]:[],R.length?[R[1],R[2],R[3]]:new THREE.Color));else if(d>4&&ze.subdivideFaces){var L=R.length?R:new THREE.Color;for(i=1;i<d-1;)M.push(new THREE.Face3(T[0],T[i],T[i+1],y.length?[y[0].clone(),y[i++].clone(),y[i].clone()]:[],L))}if(M.length)for(var w=0,x=M.length;w<x;w++)for((A=M[w]).daeMaterial=e.material,t.faces.push(A),i=0;i<f.length;i++)H=b[f[i]],N=d>4?[H[0],H[w+1],H[w+2]]:4===d?0===w?[H[0],H[1],H[3]]:[H[1].clone(),H[2],H[3].clone()]:[H[0],H[1],H[2]],void 0===t.faceVertexUvs[i]&&(t.faceVertexUvs[i]=[]),t.faceVertexUvs[i].push(N);else console.log("dropped face with vcount "+d+" for geometry with id: "+t.id);g+=p*d}}},I.prototype.setVertices=function(e){for(var t=0;t<this.inputs.length;t++)this.inputs[t].source===e.id&&(this.inputs[t].source=e.input.POSITION.source)},I.prototype.parse=function(e){this.material=e.getAttribute("material"),this.count=me(e,"count",0);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"input":this.inputs.push((new G).parse(e.childNodes[t]));break;case"vcount":this.vcount=de(r.textContent);break;case"p":this.p.push(de(r.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},F.prototype=Object.create(I.prototype),F.prototype.constructor=F,D.prototype=Object.create(I.prototype),D.prototype.constructor=D,U.prototype=Object.create(I.prototype),U.prototype.constructor=U,V.prototype.parse=function(e){this.params=[],this.source=e.getAttribute("source"),this.count=me(e,"count",0),this.stride=me(e,"stride",0);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if("param"===r.nodeName){var i={};i.name=r.getAttribute("name"),i.type=r.getAttribute("type"),this.params.push(i)}}return this},B.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++)if("input"===e.childNodes[t].nodeName){var r=(new G).parse(e.childNodes[t]);this.input[r.semantic]=r}return this},G.prototype.parse=function(e){return this.semantic=e.getAttribute("semantic"),this.source=e.getAttribute("source").replace(/^#/,""),this.set=me(e,"set",-1),this.offset=me(e,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},P.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"bool_array":this.data=le(r.textContent),this.type=r.nodeName;break;case"float_array":this.data=ue(r.textContent),this.type=r.nodeName;break;case"int_array":this.data=de(r.textContent),this.type=r.nodeName;break;case"IDREF_array":case"Name_array":this.data=pe(r.textContent),this.type=r.nodeName;break;case"technique_common":for(var i=0;i<r.childNodes.length;i++)if("accessor"===r.childNodes[i].nodeName){this.accessor=(new V).parse(r.childNodes[i]);break}}}return this},P.prototype.read=function(){var e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var r=0;r<this.data.length;r+=16){var i=we(this.data.slice(r,r+16));e.push(i)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+t.type+".")}return e},q.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++)if("instance_effect"===e.childNodes[t].nodeName){this.instance_effect=(new Z).parse(e.childNodes[t]);break}return this},Y.prototype.isColor=function(){return null===this.texture},Y.prototype.isTexture=function(){return null!=this.texture},Y.prototype.parse=function(e){"transparent"===e.nodeName&&(this.opaque=e.getAttribute("opaque"));for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"color":var i=ue(r.textContent);this.color=new THREE.Color,this.color.setRGB(i[0],i[1],i[2]),this.color.a=i[3];break;case"texture":this.texture=r.getAttribute("texture"),this.texcoord=r.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(r)}}return this},Y.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&"extra"===e.childNodes[1].nodeName&&(e=e.childNodes[1]).childNodes[1]&&"technique"===e.childNodes[1].nodeName&&(e=e.childNodes[1]);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[r.nodeName]=parseFloat(r.textContent);break;case"wrapU":case"wrapV":"TRUE"===r.textContent.toUpperCase()?this.texOpts[r.nodeName]=1:this.texOpts[r.nodeName]=parseInt(r.textContent);break;default:this.texOpts[r.nodeName]=r.textContent}}return this},X.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"emission":case"diffuse":case"specular":case"transparent":this[r.nodeName]=(new Y).parse(r);break;case"bump":var i=r.getAttribute("bumptype");i?"heightfield"===i.toLowerCase()?this.bump=(new Y).parse(r):"normalmap"===i.toLowerCase()?this.normal=(new Y).parse(r):(console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+i+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'"),this.bump=(new Y).parse(r)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new Y).parse(r));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var a=r.querySelectorAll("float");a.length>0&&(this[r.nodeName]=parseFloat(a[0].textContent))}}return this.create(),this},X.prototype.create=function(){var e={},t=!1;if(void 0!==this.transparency&&void 0!==this.transparent){this.transparent;var r=(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency;r>0&&(t=!0,e.transparent=!0,e.opacity=1-r)}var i={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var a in this)switch(a){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var s=this[a];if(s instanceof Y)if(s.isTexture()){var n=s.texture,o=this.effect.sampler[n];if(void 0!==o&&void 0!==o.source){var c=this.effect.surface[o.source];if(void 0!==c){var h=Ue[c.init_from];if(h){var l,u=Oe+h.init_from;if(altspace&&altspace.inClient)l=new THREE.Texture({src:ve(u)});else{var d=THREE.Loader.Handlers.get(u);null!==d?l=d.load(u):Ee(l=new THREE.Texture,u)}"MIRROR"===o.wrap_s?l.wrapS=THREE.MirroredRepeatWrapping:"WRAP"===o.wrap_s||s.texOpts.wrapU?l.wrapS=THREE.RepeatWrapping:l.wrapS=THREE.ClampToEdgeWrapping,"MIRROR"===o.wrap_t?l.wrapT=THREE.MirroredRepeatWrapping:"WRAP"===o.wrap_t||s.texOpts.wrapV?l.wrapT=THREE.RepeatWrapping:l.wrapT=THREE.ClampToEdgeWrapping,l.offset.x=s.texOpts.offsetU,l.offset.y=s.texOpts.offsetV,l.repeat.x=s.texOpts.repeatU,l.repeat.y=s.texOpts.repeatV,e[i[a]]=l,"emission"===a&&(e.emissive=16777215)}}}}else"diffuse"!==a&&t||("emission"===a?e.emissive=s.color.getHex():e[a]=s.color.getHex());break;case"shininess":e[a]=this[a];break;case"reflectivity":e[a]=this[a],e[a]>0&&(e.envMap=ze.defaultEnvMap),e.combine=THREE.MixOperation;break;case"index_of_refraction":e.refractionRatio=this[a],1!==this[a]&&(e.envMap=ze.defaultEnvMap)}switch(e.shading=We,e.side=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide,void 0!==e.diffuse&&(e.color=e.diffuse,delete e.diffuse),this.type){case"constant":void 0!=e.emissive&&(e.color=e.emissive),this.material=new THREE.MeshBasicMaterial(e);break;case"phong":case"blinn":this.material=new THREE.MeshPhongMaterial(e);break;case"lambert":default:this.material=new THREE.MeshLambertMaterial(e)}return this.material},W.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"init_from":this.init_from=r.textContent;break;case"format":this.format=r.textContent;break;default:console.log("unhandled Surface prop: "+r.nodeName)}}return this},z.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"source":this.source=r.textContent;break;case"minfilter":this.minfilter=r.textContent;break;case"magfilter":this.magfilter=r.textContent;break;case"mipfilter":this.mipfilter=r.textContent;break;case"wrap_s":this.wrap_s=r.textContent;break;case"wrap_t":this.wrap_t=r.textContent;break;default:console.log("unhandled Sampler2D prop: "+r.nodeName)}}return this},K.prototype.create=function(){if(null===this.shader)return null},K.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),ge(this,e),this.shader=null;for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(r))}}return this},K.prototype.parseNewparam=function(e){for(var t=e.getAttribute("sid"),r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(1==i.nodeType)switch(i.nodeName){case"surface":this.surface[t]=new W(this).parse(i);break;case"sampler2D":this.sampler[t]=new z(this).parse(i);break;case"extra":break;default:console.log(i.nodeName)}}},K.prototype.parseProfileCOMMON=function(e){for(var t,r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(1==i.nodeType)switch(i.nodeName){case"profile_COMMON":this.parseProfileCOMMON(i);break;case"technique":t=i;break;case"newparam":this.parseNewparam(i);break;case"image":var a=(new x).parse(i);Ue[a.id]=a;break;case"extra":break;default:console.log(i.nodeName)}}return t},K.prototype.parseTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new X(r.nodeName,this).parse(r);break;case"extra":this.parseExtra(r)}}},K.prototype.parseExtra=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"technique":this.parseExtraTechnique(r)}}},K.prototype.parseExtraTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"bump":this.shader.parse(e)}}},Z.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},J.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.source={};for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"animation":var i=(new J).parse(r);for(var a in i.source)this.source[a]=i.source[a];for(var s=0;s<i.channel.length;s++)this.channel.push(i.channel[s]),this.sampler.push(i.sampler[s]);break;case"source":a=(new P).parse(r);this.source[a.id]=a;break;case"sampler":this.sampler.push(new $(this).parse(r));break;case"channel":this.channel.push(new Q(this).parse(r))}}return this},Q.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,""),this.target=e.getAttribute("target");var t=this.target.split("/"),r=(t.shift(),t.shift()),i=r.indexOf(".")>=0,a=r.indexOf("(")>=0;if(i)t=r.split("."),this.sid=t.shift(),this.member=t.shift();else if(a){var s=r.split("(");this.sid=s.shift();for(var n=0;n<s.length;n++)s[n]=parseInt(s[n].replace(/\)/,""));this.arrIndices=s}else this.sid=r;return this.fullSid=r,this.dotSyntax=i,this.arrSyntax=a,this},$.prototype.parse=function(e){this.id=e.getAttribute("id"),this.inputs=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"input":this.inputs.push((new G).parse(r))}}return this},$.prototype.create=function(){for(r=0;r<this.inputs.length;r++){var e=this.inputs[r],t=this.animation.source[e.source];switch(e.semantic){case"INPUT":this.input=t.read();break;case"OUTPUT":this.output=t.read(),this.strideOut=t.accessor.stride;break;case"INTERPOLATION":this.interpolation=t.read();break;case"IN_TANGENT":case"OUT_TANGENT":break;default:console.log(e.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(var r=0;r<this.input.length;r++)this.startTime=Math.min(this.startTime,this.input[r]),this.endTime=Math.max(this.endTime,this.input[r]);this.duration=this.endTime-this.startTime}},$.prototype.getData=function(e,t,r){var i;if("matrix"===e&&16===this.strideOut)i=this.output[t];else if(this.strideOut>1){i=[],t*=this.strideOut;for(var a=0;a<this.strideOut;++a)i[a]=this.output[t+a];if(3===this.strideOut)switch(e){case"rotate":case"translate":ye(i,-1);break;case"scale":ye(i,1)}else 4===this.strideOut&&"matrix"===e&&ye(i,-1)}else i=this.output[t],r&&"translate"===e&&(i=be(r,i));return i},ee.prototype.addTarget=function(e,t,r,i){this.targets.push({sid:e,member:r,transform:t,data:i})},ee.prototype.apply=function(e){for(var t=0;t<this.targets.length;++t){var r=this.targets[t];e&&r.sid!==e||r.transform.update(r.data,r.member)}},ee.prototype.getTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return this.targets[t];return null},ee.prototype.hasTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return!0;return!1},ee.prototype.interpolate=function(e,t){for(var r=0,i=this.targets.length;r<i;r++){var a,s=this.targets[r],n=e.getTarget(s.sid);if("matrix"!==s.transform.type&&n){var o=(t-this.time)/(e.time-this.time),c=n.data,h=s.data;if(o<0&&(o=0),o>1&&(o=1),h.length){a=[];for(var l=0;l<h.length;++l)a[l]=h[l]+(c[l]-h[l])*o}else a=h+(c-h)*o}else a=s.data;s.transform.update(a,s.member)}},te.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"optics":this.parseOptics(r)}}return this},te.prototype.parseOptics=function(e){for(var t=0;t<e.childNodes.length;t++)if("technique_common"===e.childNodes[t].nodeName)for(var r=e.childNodes[t],i=0;i<r.childNodes.length;i++)if(this.technique=r.childNodes[i].nodeName,"perspective"===this.technique)for(var a=r.childNodes[i],s=0;s<a.childNodes.length;s++)switch((o=a.childNodes[s]).nodeName){case"yfov":this.yfov=o.textContent;break;case"xfov":this.xfov=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}else if("orthographic"===this.technique)for(var n=r.childNodes[i],s=0;s<n.childNodes.length;s++){var o=n.childNodes[s];switch(o.nodeName){case"xmag":this.xmag=o.textContent;break;case"ymag":this.ymag=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}}return this},re.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},ie.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"technique_common":this.parseCommon(r);break;case"technique":this.parseTechnique(r)}}return this},ie.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++)switch(e.childNodes[t].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=e.childNodes[t].nodeName;for(var r=e.childNodes[t],i=0;i<r.childNodes.length;i++){var a=r.childNodes[i];switch(a.nodeName){case"color":var s=ue(a.textContent);this.color=new THREE.Color(0),this.color.setRGB(s[0],s[1],s[2]),this.color.a=s[3];break;case"falloff_angle":this.falloff_angle=parseFloat(a.textContent);break;case"quadratic_attenuation":var n=parseFloat(a.textContent);this.distance=n?Math.sqrt(1/n):0}}}return this},ie.prototype.parseTechnique=function(e){this.profile=e.getAttribute("profile");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"intensity":this.intensity=parseFloat(r.textContent)}}return this},ae.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},se.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.joints=[],this.links=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"technique_common":this.parseCommon(r)}}return this},se.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(e.childNodes[t].nodeName){case"joint":this.joints.push((new ne).parse(r));break;case"link":this.links.push((new oe).parse(r))}}return this},ne.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0;var t=ue(e.querySelector("axis").textContent);this.axis=Re(t,0);var r=e.querySelector("limits min")?parseFloat(e.querySelector("limits min").textContent):-360,i=e.querySelector("limits max")?parseFloat(e.querySelector("limits max").textContent):360;this.limits={min:r,max:i};for(var a=["prismatic","revolute"],s=0;s<a.length;s++){var n=a[s];e.querySelector(n)&&(this.type=n)}return this.limits.min>=this.limits.max&&(this.static=!0),this.middlePosition=(this.limits.min+this.limits.max)/2,this},oe.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.transforms=[],this.attachments=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"attachment_full":this.attachments.push((new ce).parse(r));break;case"rotate":case"translate":case"matrix":this.transforms.push((new k).parse(r))}}return this},ce.prototype.parse=function(e){this.joint=e.getAttribute("joint").split("/").pop(),this.links=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"link":this.links.push((new oe).parse(r));break;case"rotate":case"translate":case"matrix":this.transforms.push((new k).parse(r))}}return this},{load:function(t,r,i,a){var s=0;if(document.implementation&&document.implementation.createDocument){var n=new XMLHttpRequest;n.onreadystatechange=function(){4===n.readyState?0===n.status||200===n.status?n.response?(Fe=r,e(n.response,void 0,t)):a?a({type:"error",url:t}):console.error("ColladaLoader: Empty or non-existing file ("+t+")"):a?a({type:"error",url:t}):console.error("ColladaLoader: Couldn't load \""+t+'" ('+n.status+")"):3===n.readyState&&i&&(0===s&&(s=n.getResponseHeader("Content-Length")),i({total:s,loaded:n.responseText.length}))},n.open("GET",t,!0),n.send(null)}else alert("Don't know how to parse XML!")},parse:e,setPreferredShading:function(e){We=e},applySkin:p,geometries:Ge,options:ze}},THREE.GLTFLoader=function(){function e(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager}function t(){var e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}},update:function(t,r){for(var i in e){var a=e[i];a.update&&a.update(t,r)}}}}function r(e,t){var r={},i=e.material.uniforms;for(var a in i){var s=i[a];if(s.semantic){var n=s.node,o=e;n&&(o=t[n]),r[a]={semantic:s.semantic,sourceNode:o,targetNode:e,uniform:s}}}this.boundUniforms=r,this._m4=new THREE.Matrix4}function i(e){this.name=l.KHR_MATERIALS_COMMON,this.lights={};var t=(e.extensions&&e.extensions[l.KHR_MATERIALS_COMMON]||{}).lights||{};for(var r in t){var i,a=t[r],s=a[a.type],n=(new THREE.Color).fromArray(s.color);switch(a.type){case"directional":(i=new THREE.DirectionalLight(n)).position.set(0,0,1);break;case"point":i=new THREE.PointLight(n);break;case"spot":(i=new THREE.SpotLight(n)).position.set(0,0,1);break;case"ambient":i=new THREE.AmbientLight(n)}i&&(this.lights[r]=i)}}function a(e){this.name=l.KHR_BINARY_GLTF;var t=new DataView(e,0,d),r={magic:o(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0),contentLength:t.getUint32(12,!0),contentFormat:t.getUint32(16,!0)};for(var i in u){var a=u[i];if(r[i]!==a)throw new Error('Unsupported glTF-Binary header: Expected "%s" to be "%s".',i,a)}var s=new Uint8Array(e,d,r.contentLength);this.header=r,this.content=o(s),this.body=e.slice(d+r.contentLength,r.length)}function s(e,t,r){if(!e)return Promise.resolve();var i,a=[];if("[object Array]"===Object.prototype.toString.call(e)){i=[];for(var s=e.length,n=0;n<s;n++)(c=t.call(r||this,e[n],n))&&(a.push(c),c instanceof Promise?c.then(function(e,t){i[e]=t}.bind(this,n)):i[n]=c)}else{i={};for(var o in e)if(e.hasOwnProperty(o)){var c=t.call(r||this,e[o],o);c&&(a.push(c),c instanceof Promise?c.then(function(e,t){i[e]=t}.bind(this,o)):i[o]=c)}}return Promise.all(a).then(function(){return i})}function n(e,t){return"string"!=typeof e||""===e?"":/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:new URL((t||"")+e,location.href.substring(0,location.href.lastIndexOf("/")+1)).toString()}function o(e){for(var t="",r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t}function c(){return new THREE.MeshPhongMaterial({color:0,emissive:8947848,specular:0,shininess:0,transparent:!1,depthTest:!0,side:THREE.FrontSide})}function h(e,r,i){this.json=e||{},this.extensions=r||{},this.options=i||{},this.cache=new t}e.prototype={constructor:e,load:function(e,t,r,i){var a=this,s=this.path&&"string"==typeof this.path?this.path:THREE.Loader.prototype.extractUrlBase(e),n=new THREE.FileLoader(a.manager);n.setResponseType("arraybuffer"),n.load(e,function(e){a.parse(e,t,s)},r,i)},setCrossOrigin:function(e){this.crossOrigin=e},setPath:function(e){this.path=e},parse:function(e,t,r){var s,n={};o(new Uint8Array(e,0,4))===u.magic?(n[l.KHR_BINARY_GLTF]=new a(e),s=n[l.KHR_BINARY_GLTF].content):s=o(new Uint8Array(e));var c=JSON.parse(s);c.extensionsUsed&&c.extensionsUsed.indexOf(l.KHR_MATERIALS_COMMON)>=0&&(n[l.KHR_MATERIALS_COMMON]=new i(c)),console.time("GLTFLoader"),new h(c,n,{path:r||this.path,crossOrigin:this.crossOrigin}).parse(function(e,r,i,a){console.log("------------ UltimateLoader ---------------"),console.timeEnd("GLTFLoader"),t({scene:e,scenes:r,cameras:i,animations:a})})}},e.Shaders={update:function(){console.warn("THREE.GLTFLoader.Shaders has been deprecated, and now updates automatically.")}},r.prototype.update=function(e,t){var r=this.boundUniforms;for(var i in r){var a=r[i];switch(a.semantic){case"MODELVIEW":(n=a.uniform.value).multiplyMatrices(t.matrixWorldInverse,a.sourceNode.matrixWorld);break;case"MODELVIEWINVERSETRANSPOSE":var s=a.uniform.value;this._m4.multiplyMatrices(t.matrixWorldInverse,a.sourceNode.matrixWorld),s.getNormalMatrix(this._m4);break;case"PROJECTION":var n=a.uniform.value;n.copy(t.projectionMatrix);break;case"JOINTMATRIX":for(var o=a.uniform.value,c=0;c<o.length;c++)o[c].getInverse(a.sourceNode.matrixWorld).multiply(a.targetNode.skeleton.bones[c].matrixWorld).multiply(a.targetNode.skeleton.boneInverses[c]).multiply(a.targetNode.bindMatrix);break;default:console.warn("Unhandled shader semantic: "+a.semantic)}}},e.Animations={update:function(){console.warn("THREE.GLTFLoader.Animation has been deprecated. Use THREE.AnimationMixer instead.")}};var l={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_MATERIALS_COMMON:"KHR_materials_common"},u={magic:"glTF",version:1,contentFormat:0},d=20;a.prototype.loadShader=function(e,t){var r=t[e.extensions[l.KHR_BINARY_GLTF].bufferView];return o(new Uint8Array(r))},a.prototype.loadTextureSourceUri=function(e,t){var r=e.extensions[l.KHR_BINARY_GLTF],i=t[r.bufferView],a=o(new Uint8Array(i));return"data:"+r.mimeType+";base64,"+btoa(a)};var p={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,TRIANGLES:4,LINES:1,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,VERTEX_SHADER:35633,FRAGMENT_SHADER:35632},f=(Number,THREE.Matrix3,THREE.Matrix4,THREE.Vector2,THREE.Vector3,THREE.Vector4,THREE.Texture,{5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array}),m={9728:THREE.NearestFilter,9729:THREE.LinearFilter,9984:THREE.NearestMipMapNearestFilter,9985:THREE.LinearMipMapNearestFilter,9986:THREE.NearestMipMapLinearFilter,9987:THREE.LinearMipMapLinearFilter},v={33071:THREE.ClampToEdgeWrapping,33648:THREE.MirroredRepeatWrapping,10497:THREE.RepeatWrapping},E={6406:THREE.AlphaFormat,6407:THREE.RGBFormat,6408:THREE.RGBAFormat,6409:THREE.LuminanceFormat,6410:THREE.LuminanceAlphaFormat},g={5121:THREE.UnsignedByteType,32819:THREE.UnsignedShort4444Type,32820:THREE.UnsignedShort5551Type,33635:THREE.UnsignedShort565Type},T=(THREE.BackSide,THREE.FrontSide,THREE.NeverDepth,THREE.LessDepth,THREE.EqualDepth,THREE.LessEqualDepth,THREE.GreaterEqualDepth,THREE.NotEqualDepth,THREE.GreaterEqualDepth,THREE.AlwaysDepth,THREE.AddEquation,THREE.SubtractEquation,THREE.ReverseSubtractEquation,THREE.ZeroFactor,THREE.OneFactor,THREE.SrcColorFactor,THREE.OneMinusSrcColorFactor,THREE.SrcAlphaFactor,THREE.OneMinusSrcAlphaFactor,THREE.DstAlphaFactor,THREE.OneMinusDstAlphaFactor,THREE.DstColorFactor,THREE.OneMinusDstColorFactor,THREE.SrcAlphaSaturateFactor,{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}),y={scale:"scale",translation:"position",rotation:"quaternion"},b={LINEAR:THREE.InterpolateLinear,STEP:THREE.InterpolateDiscrete};return function(e){this.isDeferredShaderMaterial=!0,this.params=e}.prototype.create=function(){var e=THREE.UniformsUtils.clone(this.params.uniforms);for(var t in this.params.uniforms){var r=this.params.uniforms[t];r.value instanceof THREE.Texture&&(e[t].value=r.value,e[t].value.needsUpdate=!0),e[t].semantic=r.semantic,e[t].node=r.node}return this.params.uniforms=e,new THREE.RawShaderMaterial(this.params)},h.prototype._withDependencies=function(e){for(var t={},r=0;r<e.length;r++){var i=e[r],a="load"+i.charAt(0).toUpperCase()+i.slice(1),n=this.cache.get(i);if(void 0!==n)t[i]=n;else if(this[a]){var o=this[a]();this.cache.add(i,o),t[i]=o}}return s(t,function(e){return e})},h.prototype.parse=function(e){var t=this.json;this.cache.removeAll(),this._withDependencies(["scenes","cameras","animations"]).then(function(r){var i=[];for(var a in r.scenes)i.push(r.scenes[a]);var s=void 0!==t.scene?r.scenes[t.scene]:i[0],n=[];for(var a in r.cameras){var o=r.cameras[a];n.push(o)}var c=[];for(var a in r.animations)c.push(r.animations[a]);e(s,i,n,c)})},h.prototype.loadShaders=function(){var e=this.json,t=this.extensions,r=this.options;return this._withDependencies(["bufferViews"]).then(function(i){return s(e.shaders,function(e){return e.extensions&&e.extensions[l.KHR_BINARY_GLTF]?t[l.KHR_BINARY_GLTF].loadShader(e,i.bufferViews):new Promise(function(t){var i=new THREE.FileLoader;i.setResponseType("text"),i.load(n(e.uri,r.path),function(e){t(e)})})})})},h.prototype.loadBuffers=function(){var e=this.json,t=this.extensions,r=this.options;return s(e.buffers,function(e,i){return"binary_glTF"===i?t[l.KHR_BINARY_GLTF].body:"arraybuffer"===e.type||void 0===e.type?new Promise(function(t){var i=new THREE.FileLoader;i.setResponseType("arraybuffer"),i.load(n(e.uri,r.path),function(e){t(e)})}):void console.warn("THREE.GLTFLoader: "+e.type+" buffer type is not supported")})},h.prototype.loadBufferViews=function(){var e=this.json;return this._withDependencies(["buffers"]).then(function(t){return s(e.bufferViews,function(e){var r=t.buffers[e.buffer],i=void 0!==e.byteLength?e.byteLength:0;return r.slice(e.byteOffset,e.byteOffset+i)})})},h.prototype.loadAccessors=function(){var e=this.json;return this._withDependencies(["bufferViews"]).then(function(t){return s(e.accessors,function(e){var r=t.bufferViews[e.bufferView],i=T[e.type],a=f[e.componentType],s=a.BYTES_PER_ELEMENT,n=s*i;if(e.byteStride&&e.byteStride!==n){var o=new a(r),c=new THREE.InterleavedBuffer(o,e.byteStride/s);return new THREE.InterleavedBufferAttribute(c,i,e.byteOffset/s)}return o=new a(r,e.byteOffset,e.count*i),new THREE.BufferAttribute(o,i)})})},h.prototype.loadTextures=function(){var e=this.json,t=this.extensions,r=this.options;return this._withDependencies(["bufferViews"]).then(function(i){return s(e.textures,function(a){function s(t){if(t.flipY=!1,void 0!==a.name&&(t.name=a.name),t.format=void 0!==a.format?E[a.format]:THREE.RGBAFormat,void 0!==a.internalFormat&&t.format!==E[a.internalFormat]&&console.warn("THREE.GLTFLoader: Three.js doesn't support texture internalFormat which is different from texture format. internalFormat will be forced to be the same value as format."),t.type=void 0!==a.type?g[a.type]:THREE.UnsignedByteType,a.sampler){var r=e.samplers[a.sampler];t.magFilter=m[r.magFilter]||THREE.LinearFilter,t.minFilter=m[r.minFilter]||THREE.NearestMipMapLinearFilter,t.wrapS=v[r.wrapS]||THREE.RepeatWrapping,t.wrapT=v[r.wrapT]||THREE.RepeatWrapping}}if(a.source)return new Promise(function(o){var c=e.images[a.source],h=c.uri;if(c.extensions&&c.extensions[l.KHR_BINARY_GLTF]&&(h=t[l.KHR_BINARY_GLTF].loadTextureSourceUri(c,i.bufferViews)),altspace&&altspace.inClient)s(a=new THREE.Texture({src:n(h,r.path)})),o(a);else{var u=THREE.Loader.Handlers.get(h);null===u&&(u=new THREE.TextureLoader),u.setCrossOrigin(r.crossOrigin),u.load(n(h,r.path),function(e){s(e),o(e)},void 0,function(){o()})}})})})},h.prototype.loadMaterials=function(){var e=this.json;return this._withDependencies(["shaders","textures"]).then(function(t){return s(e.materials,function(e){var r,i,a={},s={};if(e.extensions&&e.extensions[l.KHR_MATERIALS_COMMON]&&(i=e.extensions[l.KHR_MATERIALS_COMMON]),i){var n=["ambient","emission","transparent","transparency","doubleSided"];switch(i.technique){case"BLINN":case"PHONG":r=THREE.MeshPhongMaterial,n.push("diffuse","specular","shininess");break;case"LAMBERT":r=THREE.MeshLambertMaterial,n.push("diffuse");break;case"CONSTANT":default:r=THREE.MeshBasicMaterial}n.forEach(function(e){void 0!==i.values[e]&&(a[e]=i.values[e])}),(i.doubleSided||a.doubleSided)&&(s.side=THREE.DoubleSide),(i.transparent||a.transparent)&&(s.transparent=!0,s.opacity=void 0!==a.transparency?a.transparency:1)}else r=THREE.MeshPhongMaterial,Object.assign(a,e.values);Array.isArray(a.diffuse)?s.color=(new THREE.Color).fromArray(a.diffuse):"string"==typeof a.diffuse&&(s.map=t.textures[a.diffuse]),delete s.diffuse,"string"==typeof a.reflective&&(s.envMap=t.textures[a.reflective]),"string"==typeof a.bump&&(s.bumpMap=t.textures[a.bump]),Array.isArray(a.emission)?r===THREE.MeshBasicMaterial?s.color=(new THREE.Color).fromArray(a.emission):s.emissive=(new THREE.Color).fromArray(a.emission):"string"==typeof a.emission&&(r===THREE.MeshBasicMaterial?s.map=t.textures[a.emission]:s.emissiveMap=t.textures[a.emission]),Array.isArray(a.specular)?s.specular=(new THREE.Color).fromArray(a.specular):"string"==typeof a.specular&&(s.specularMap=t.textures[a.specular]),void 0!==a.shininess&&(s.shininess=a.shininess);var o=new r(s);return void 0!==e.name&&(o.name=e.name),o})})},h.prototype.loadMeshes=function(){var e=this.json;return this._withDependencies(["accessors","materials"]).then(function(t){return s(e.meshes,function(e){var r=new THREE.Group;void 0!==e.name&&(r.name=e.name),e.extras&&(r.userData=e.extras);var i=e.primitives||[];for(var a in i){var s=i[a];if(s.mode===p.TRIANGLES||void 0===s.mode){var n=new THREE.BufferGeometry,o=s.attributes;for(var h in o){if(!(l=o[h]))return;u=t.accessors[l];switch(h){case"POSITION":n.addAttribute("position",u);break;case"NORMAL":n.addAttribute("normal",u);break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":n.addAttribute("uv",u);break;case"TEXCOORD_1":n.addAttribute("uv2",u);break;case"COLOR_0":case"COLOR0":case"COLOR":n.addAttribute("color",u);break;case"WEIGHT":n.addAttribute("skinWeight",u);break;case"JOINT":n.addAttribute("skinIndex",u)}}s.indices&&n.setIndex(t.accessors[s.indices]);f=void 0!==t.materials?t.materials[s.material]:c();(d=new THREE.Mesh(n,f)).castShadow=!0,d.name="0"===a?r.name:r.name+a,s.extras&&(d.userData=s.extras),r.add(d)}else if(s.mode===p.LINES){var n=new THREE.BufferGeometry,o=s.attributes;for(var h in o){var l=o[h];if(!l)return;var u=t.accessors[l];switch(h){case"POSITION":n.addAttribute("position",u);break;case"COLOR_0":case"COLOR0":case"COLOR":n.addAttribute("color",u)}}var d,f=t.materials[s.material];s.indices?(n.setIndex(t.accessors[s.indices]),d=new THREE.LineSegments(n,f)):d=new THREE.Line(n,f),d.name="0"===a?r.name:r.name+a,s.extras&&(d.userData=s.extras),r.add(d)}else console.warn("Only triangular and line primitives are supported")}return r})})},h.prototype.loadCameras=function(){return s(this.json.cameras,function(e){if("perspective"==e.type&&e.perspective){var t=e.perspective.yfov,r=void 0!==e.perspective.aspectRatio?e.perspective.aspectRatio:1,i=t*r,a=new THREE.PerspectiveCamera(THREE.Math.radToDeg(i),r,e.perspective.znear||1,e.perspective.zfar||2e6);return void 0!==e.name&&(a.name=e.name),e.extras&&(a.userData=e.extras),a}if("orthographic"==e.type&&e.orthographic){a=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,e.orthographic.znear,e.orthographic.zfar);return void 0!==e.name&&(a.name=e.name),e.extras&&(a.userData=e.extras),a}})},h.prototype.loadSkins=function(){var e=this.json;return this._withDependencies(["accessors"]).then(function(t){return s(e.skins,function(e){var r=new THREE.Matrix4;return void 0!==e.bindShapeMatrix&&r.fromArray(e.bindShapeMatrix),{bindShapeMatrix:r,jointNames:e.jointNames,inverseBindMatrices:t.accessors[e.inverseBindMatrices]}})})},h.prototype.loadAnimations=function(){var e=this.json;return this._withDependencies(["accessors","nodes"]).then(function(t){return s(e.animations,function(e,r){var i=[];for(var a in e.channels){var s=e.channels[a],n=e.samplers[s.sampler];if(n){var o=s.target,c=o.id,h=void 0!==e.parameters?e.parameters[n.input]:n.input,l=void 0!==e.parameters?e.parameters[n.output]:n.output,u=t.accessors[h],d=t.accessors[l],p=t.nodes[c];if(p){p.updateMatrix(),p.matrixAutoUpdate=!0;var f=y[o.path]===y.rotation?THREE.QuaternionKeyframeTrack:THREE.VectorKeyframeTrack,m=p.name?p.name:p.uuid,v=void 0!==n.interpolation?b[n.interpolation]:THREE.InterpolateLinear;i.push(new f(m+"."+y[o.path],THREE.AnimationUtils.arraySlice(u.array,0),THREE.AnimationUtils.arraySlice(d.array,0),v))}}}c=void 0!==e.name?e.name:"animation_"+r;return new THREE.AnimationClip(c,void 0,i)})})},h.prototype.loadNodes=function(){var e=this.json,t=this.extensions,r=this;return s(e.nodes,function(e){var t,r=new THREE.Matrix4;return e.jointName?((t=new THREE.Bone).name=void 0!==e.name?e.name:e.jointName,t.jointName=e.jointName):(t=new THREE.Object3D,void 0!==e.name&&(t.name=e.name)),e.extras&&(t.userData=e.extras),void 0!==e.matrix?(r.fromArray(e.matrix),t.applyMatrix(r)):(void 0!==e.translation&&t.position.fromArray(e.translation),void 0!==e.rotation&&t.quaternion.fromArray(e.rotation),void 0!==e.scale&&t.scale.fromArray(e.scale)),t}).then(function(i){return r._withDependencies(["meshes","skins","cameras"]).then(function(r){return s(i,function(a,s){var n=e.nodes[s];if(void 0!==n.meshes)for(var o in n.meshes){var c=n.meshes[o],h=r.meshes[c];if(void 0!==h)for(var u in h.children){var d,p=h.children[u],f=p.material,m=p.geometry,v=p.userData,E=p.name;switch(f.isDeferredShaderMaterial?f=d=f.create():d=f,p.type){case"LineSegments":p=new THREE.LineSegments(m,d);break;case"LineLoop":p=new THREE.LineLoop(m,d);break;case"Line":p=new THREE.Line(m,d);break;default:p=new THREE.Mesh(m,d)}p.castShadow=!0,p.userData=v,p.name=E;var g;if(n.skin&&(g=r.skins[n.skin]),g){var T=m;(d=f).skinning=!0,(p=new THREE.SkinnedMesh(T,d,!1)).castShadow=!0,p.userData=v,p.name=E;for(var y=[],b=[],R=0,w=g.jointNames.length;R<w;R++){var x=g.jointNames[R],H=function(e){for(var t=Object.keys(i),r=0,a=t.length;r<a;r++){var s=i[t[r]];if(s.jointName===e)return s}return null}(x);if(H){y.push(H);var N=g.inverseBindMatrices.array,A=(new THREE.Matrix4).fromArray(N,16*R);b.push(A)}else console.warn("WARNING: joint: '"+x+"' could not be found")}p.bind(new THREE.Skeleton(y,b,!1),g.bindShapeMatrix);var M=function(t,r,a){var s=t[a];if(void 0!==s)for(var n=0,o=s.length;n<o;n++){var c=s[n],h=i[c],l=e.nodes[c];void 0!==h&&!0===h.isBone&&void 0!==l&&(r.add(h),M(l,h,"children"))}};M(n,p,"skeletons")}a.add(p)}else console.warn("GLTFLoader: Couldn't find node \""+c+'".')}if(void 0!==n.camera){var L=r.cameras[n.camera];a.add(L)}if(n.extensions&&n.extensions[l.KHR_MATERIALS_COMMON]&&n.extensions[l.KHR_MATERIALS_COMMON].light){var k=t[l.KHR_MATERIALS_COMMON].lights[n.extensions[l.KHR_MATERIALS_COMMON].light];a.add(k)}return a})})})},h.prototype.loadScenes=function(){function e(r,i,a){var s=a[r];i.add(s);var n=t.nodes[r];if(n.children)for(var o=n.children,c=0,h=o.length;c<h;c++)e(o[c],s,a)}var t=this.json;return this._withDependencies(["nodes"]).then(function(i){return s(t.scenes,function(t){var a=new THREE.Scene;void 0!==t.name&&(a.name=t.name),t.extras&&(a.userData=t.extras);for(var s=t.nodes||[],n=0,o=s.length;n<o;n++)e(s[n],a,i.nodes);return a.traverse(function(e){e.material&&e.material.isRawShaderMaterial&&(e.gltfShader=new r(e,i.nodes),e.onBeforeRender=function(e,t,r){this.gltfShader.update(t,r)})}),a})})},e}(),THREE.GLTFLoader=function(){function e(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager}function t(){var e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}},update:function(t,r){for(var i in e){var a=e[i];a.update&&a.update(t,r)}}}}function r(e,t){var r={},i=e.material.uniforms;for(var a in i){var s=i[a];if(s.semantic){var n=s.node,o=e;n&&(o=t[n]),r[a]={semantic:s.semantic,sourceNode:o,targetNode:e,uniform:s}}}this.boundUniforms=r,this._m4=new THREE.Matrix4}function i(e){this.name=l.KHR_MATERIALS_COMMON,this.lights={};var t=(e.extensions&&e.extensions[l.KHR_MATERIALS_COMMON]||{}).lights||{};for(var r in t){var i,a=t[r],s=a[a.type],n=(new THREE.Color).fromArray(s.color);switch(a.type){case"directional":(i=new THREE.DirectionalLight(n)).position.set(0,0,1);break;case"point":i=new THREE.PointLight(n);break;case"spot":(i=new THREE.SpotLight(n)).position.set(0,0,1);break;case"ambient":i=new THREE.AmbientLight(n)}i&&(this.lights[r]=i)}}function a(e){this.name=l.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,d);if(this.header={magic:o(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==u)throw new Error("GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("GLTFLoader: Legacy binary file detected. Use GLTFLoader instead.");for(var r=new DataView(e,d),i=0;i<r.byteLength;){var a=r.getUint32(i,!0);i+=4;var s=r.getUint32(i,!0);if(i+=4,s===p.JSON){var n=new Uint8Array(e,d+i,a);this.content=o(n)}else if(s===p.BIN){var c=d+i;this.body=e.slice(c,c+a)}i+=a}if(null===this.content)throw new Error("GLTFLoader: JSON content not found.")}function s(e,t,r){if(!e)return Promise.resolve();var i,a=[];if("[object Array]"===Object.prototype.toString.call(e)){i=[];for(var s=e.length,n=0;n<s;n++)(c=t.call(r||this,e[n],n))&&(a.push(c),c instanceof Promise?c.then(function(e,t){i[e]=t}.bind(this,n)):i[n]=c)}else{i={};for(var o in e)if(e.hasOwnProperty(o)){var c=t.call(r||this,e[o],o);c&&(a.push(c),c instanceof Promise?c.then(function(e,t){i[e]=t}.bind(this,o)):i[o]=c)}}return Promise.all(a).then(function(){return i})}function n(e,t){return"string"!=typeof e||""===e?"":/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:/^blob:.*$/i.test(e)?e:(t||"")+e}function o(e){for(var t="",r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t}function c(){return new THREE.MeshPhongMaterial({color:0,emissive:8947848,specular:0,shininess:0,transparent:!1,depthTest:!0,side:THREE.FrontSide})}function h(e,r,i){this.json=e||{},this.extensions=r||{},this.options=i||{},this.cache=new t}e.prototype={constructor:e,load:function(e,t,r,i){var a=this,s=this.path&&"string"==typeof this.path?this.path:THREE.Loader.prototype.extractUrlBase(e),n=new THREE.FileLoader(a.manager);n.setResponseType("arraybuffer"),n.load(e,function(e){a.parse(e,t,s)},r,i)},setCrossOrigin:function(e){this.crossOrigin=e},setPath:function(e){this.path=e},parse:function(e,t,r){var s,n={};o(new Uint8Array(e,0,4))===u?(n[l.KHR_BINARY_GLTF]=new a(e),s=n[l.KHR_BINARY_GLTF].content):s=o(new Uint8Array(e));var c=JSON.parse(s);c.extensionsUsed&&c.extensionsUsed.indexOf(l.KHR_MATERIALS_COMMON)>=0&&(n[l.KHR_MATERIALS_COMMON]=new i(c)),console.time("GLTFLoader"),new h(c,n,{path:r||this.path,crossOrigin:this.crossOrigin}).parse(function(e,r,i,a){console.timeEnd("GLTFLoader"),t({scene:e,scenes:r,cameras:i,animations:a})})}},r.prototype.update=function(e,t){var r=this.boundUniforms;for(var i in r){var a=r[i];switch(a.semantic){case"MODELVIEW":(n=a.uniform.value).multiplyMatrices(t.matrixWorldInverse,a.sourceNode.matrixWorld);break;case"MODELVIEWINVERSETRANSPOSE":var s=a.uniform.value;this._m4.multiplyMatrices(t.matrixWorldInverse,a.sourceNode.matrixWorld),s.getNormalMatrix(this._m4);break;case"PROJECTION":var n=a.uniform.value;n.copy(t.projectionMatrix);break;case"JOINTMATRIX":for(var o=a.uniform.value,c=0;c<o.length;c++)o[c].getInverse(a.sourceNode.matrixWorld).multiply(a.targetNode.skeleton.bones[c].matrixWorld).multiply(a.targetNode.skeleton.boneInverses[c]).multiply(a.targetNode.bindMatrix);break;default:console.warn("Unhandled shader semantic: "+a.semantic)}}};var l={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_MATERIALS_COMMON:"KHR_materials_common"},u="glTF",d=12,p={JSON:1313821514,BIN:5130562},f={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,TRIANGLES:4,LINES:1,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,VERTEX_SHADER:35633,FRAGMENT_SHADER:35632},m=(Number,THREE.Matrix3,THREE.Matrix4,THREE.Vector2,THREE.Vector3,THREE.Vector4,THREE.Texture,{5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array}),v={9728:THREE.NearestFilter,9729:THREE.LinearFilter,9984:THREE.NearestMipMapNearestFilter,9985:THREE.LinearMipMapNearestFilter,9986:THREE.NearestMipMapLinearFilter,9987:THREE.LinearMipMapLinearFilter},E={33071:THREE.ClampToEdgeWrapping,33648:THREE.MirroredRepeatWrapping,10497:THREE.RepeatWrapping},g={6406:THREE.AlphaFormat,6407:THREE.RGBFormat,6408:THREE.RGBAFormat,6409:THREE.LuminanceFormat,6410:THREE.LuminanceAlphaFormat},T={5121:THREE.UnsignedByteType,32819:THREE.UnsignedShort4444Type,32820:THREE.UnsignedShort5551Type,33635:THREE.UnsignedShort565Type},y=(THREE.BackSide,THREE.FrontSide,THREE.NeverDepth,THREE.LessDepth,THREE.EqualDepth,THREE.LessEqualDepth,THREE.GreaterEqualDepth,THREE.NotEqualDepth,THREE.GreaterEqualDepth,THREE.AlwaysDepth,THREE.AddEquation,THREE.SubtractEquation,THREE.ReverseSubtractEquation,THREE.ZeroFactor,THREE.OneFactor,THREE.SrcColorFactor,THREE.OneMinusSrcColorFactor,THREE.SrcAlphaFactor,THREE.OneMinusSrcAlphaFactor,THREE.DstAlphaFactor,THREE.OneMinusDstAlphaFactor,THREE.DstColorFactor,THREE.OneMinusDstColorFactor,THREE.SrcAlphaSaturateFactor,{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}),b={scale:"scale",translation:"position",rotation:"quaternion"},R={LINEAR:THREE.InterpolateLinear,STEP:THREE.InterpolateDiscrete};return function(e){this.isDeferredShaderMaterial=!0,this.params=e}.prototype.create=function(){var e=THREE.UniformsUtils.clone(this.params.uniforms);for(var t in this.params.uniforms){var r=this.params.uniforms[t];r.value instanceof THREE.Texture&&(e[t].value=r.value,e[t].value.needsUpdate=!0),e[t].semantic=r.semantic,e[t].node=r.node}return this.params.uniforms=e,new THREE.RawShaderMaterial(this.params)},h.prototype._withDependencies=function(e){for(var t={},r=0;r<e.length;r++){var i=e[r],a="load"+i.charAt(0).toUpperCase()+i.slice(1),n=this.cache.get(i);if(void 0!==n)t[i]=n;else if(this[a]){var o=this[a]();this.cache.add(i,o),t[i]=o}}return s(t,function(e){return e})},h.prototype.parse=function(e){var t=this.json;this.cache.removeAll(),this._withDependencies(["scenes","cameras","animations"]).then(function(r){var i=[];for(var a in r.scenes)i.push(r.scenes[a]);var s=void 0!==t.scene?r.scenes[t.scene]:i[0],n=[];for(var a in r.cameras){var o=r.cameras[a];n.push(o)}var c=[];for(var a in r.animations)c.push(r.animations[a]);e(s,i,n,c)})},h.prototype.loadShaders=function(){var e=this.json,t=this.options;return this._withDependencies(["bufferViews"]).then(function(r){return s(e.shaders,function(e){if(void 0!==e.bufferView){var i=r.bufferViews[e.bufferView];return o(new Uint8Array(i))}return new Promise(function(r){var i=new THREE.FileLoader;i.setResponseType("text"),i.load(n(e.uri,t.path),function(e){r(e)})})})})},h.prototype.loadBuffers=function(){var e=this.json,t=this.extensions,r=this.options;return s(e.buffers,function(e,i){return"arraybuffer"===e.type||void 0===e.type?void 0===e.uri&&0===i?t[l.KHR_BINARY_GLTF].body:new Promise(function(t){var i=new THREE.FileLoader;i.setResponseType("arraybuffer"),i.load(n(e.uri,r.path),function(e){t(e)})}):void console.warn("THREE.GLTFLoader: "+e.type+" buffer type is not supported")})},h.prototype.loadBufferViews=function(){var e=this.json;return this._withDependencies(["buffers"]).then(function(t){return s(e.bufferViews,function(e){var r=t.buffers[e.buffer],i=void 0!==e.byteLength?e.byteLength:0;return r.slice(e.byteOffset,e.byteOffset+i)})})},h.prototype.loadAccessors=function(){var e=this.json;return this._withDependencies(["bufferViews"]).then(function(t){return s(e.accessors,function(e){var r,i=t.bufferViews[e.bufferView],a=y[e.type],s=m[e.componentType],n=s.BYTES_PER_ELEMENT,o=n*a;if(e.byteStride&&e.byteStride!==o){r=new s(i);var c=new THREE.InterleavedBuffer(r,e.byteStride/n);return new THREE.InterleavedBufferAttribute(c,a,e.byteOffset/n)}return r=new s(i,e.byteOffset,e.count*a),new THREE.BufferAttribute(r,a)})})},h.prototype.loadTextures=function(){var e=this.json,t=this.options;return this._withDependencies(["bufferViews"]).then(function(r){return s(e.textures,function(i){if(void 0!==i.source)return new Promise(function(a){var s,o=e.images[i.source],c=o.uri;if(void 0!==o.bufferView){var h=r.bufferViews[o.bufferView],l=new Blob([h],{type:o.mimeType});s=window.URL||window.webkitURL,c=s.createObjectURL(l)}var u=THREE.Loader.Handlers.get(c);null===u&&(u=new THREE.TextureLoader),u.setCrossOrigin(t.crossOrigin),u.load(n(c,t.path),function(t){if(void 0!==s&&s.revokeObjectURL(c),t.flipY=!1,void 0!==i.name&&(t.name=i.name),t.format=void 0!==i.format?g[i.format]:THREE.RGBAFormat,void 0!==i.internalFormat&&t.format!==g[i.internalFormat]&&console.warn("THREE.GLTFLoader: Three.js doesn't support texture internalFormat which is different from texture format. internalFormat will be forced to be the same value as format."),t.type=void 0!==i.type?T[i.type]:THREE.UnsignedByteType,void 0!==i.sampler){var r=e.samplers[i.sampler];t.magFilter=v[r.magFilter]||THREE.LinearFilter,t.minFilter=v[r.minFilter]||THREE.NearestMipMapLinearFilter,t.wrapS=E[r.wrapS]||THREE.RepeatWrapping,t.wrapT=E[r.wrapT]||THREE.RepeatWrapping}a(t)},void 0,function(){a()})})})})},h.prototype.loadMaterials=function(){var e=this.json;return this._withDependencies(["shaders","textures"]).then(function(t){return s(e.materials,function(e){var r,i,a={},s={};if(e.extensions&&e.extensions[l.KHR_MATERIALS_COMMON]&&(i=e.extensions[l.KHR_MATERIALS_COMMON]),i){var n=["ambient","emission","transparent","transparency","doubleSided"];switch(i.technique){case"LAMBERT":r=THREE.MeshLambertMaterial,n.push("diffuse");break;case"CONSTANT":default:r=THREE.MeshBasicMaterial}n.forEach(function(e){void 0!==i.values[e]&&(a[e]=i.values[e])}),(i.doubleSided||a.doubleSided)&&(s.side=THREE.DoubleSide),(i.transparent||a.transparent)&&(s.transparent=!0,s.opacity=void 0!==a.transparency?a.transparency:1)}else r=THREE.MeshBasicMaterial,Object.assign(a,e.values);this.textureArray=t.textures,Array.isArray(a.diffuse)?s.color=(new THREE.Color).fromArray(a.diffuse):"string"==typeof a.diffuse&&(s.map=t.textures[a.diffuse]),delete s.diffuse,"string"==typeof a.reflective&&(s.envMap=t.textures[a.reflective]),"string"==typeof a.bump&&(s.bumpMap=t.textures[a.bump]),Array.isArray(a.emission)?r===THREE.MeshBasicMaterial?s.color=(new THREE.Color).fromArray(a.emission):s.emissive=(new THREE.Color).fromArray(a.emission):"string"==typeof a.emission&&(r===THREE.MeshBasicMaterial?s.map=t.textures[a.emission]:s.emissiveMap=t.textures[a.emission]),Array.isArray(a.specular)?s.specular=(new THREE.Color).fromArray(a.specular):"string"==typeof a.specular&&(s.specularMap=t.textures[a.specular]),void 0!==a.shininess&&(s.shininess=a.shininess);var o=new r(s);return void 0!==e.name&&(o.name=e.name),o})})},h.prototype.loadMeshes=function(){var e=this.json;return this._withDependencies(["accessors","materials"]).then(function(t){return s(e.meshes,function(e){var r=new THREE.Group;void 0!==e.name&&(r.name=e.name),e.extras&&(r.userData=e.extras);var i=e.primitives||[];for(var a in i){var s,n,o=i[a],h=void 0!==o.material?t.materials[o.material]:c();if(o.mode===f.TRIANGLES||void 0===o.mode){s=new THREE.BufferGeometry;u=o.attributes;for(var l in u){if(void 0===(d=u[l]))return;p=t.accessors[d];switch(l){case"POSITION":s.addAttribute("position",p);break;case"NORMAL":s.addAttribute("normal",p);break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":s.addAttribute("uv",p);break;case"TEXCOORD_1":s.addAttribute("uv2",p);break;case"COLOR_0":case"COLOR0":case"COLOR":s.addAttribute("color",p);break;case"WEIGHTS_0":case"WEIGHT":s.addAttribute("skinWeight",p);break;case"JOINTS_0":case"JOINT":s.addAttribute("skinIndex",p)}}void 0!==o.indices&&s.setIndex(t.accessors[o.indices]),(n=new THREE.Mesh(s,h)).castShadow=!0}else{if(o.mode!==f.LINES)throw new Error("Only triangular and line primitives are supported");s=new THREE.BufferGeometry;var u=o.attributes;for(var l in u){var d=u[l];if(!d)return;var p=t.accessors[d];switch(l){case"POSITION":s.addAttribute("position",p);break;case"COLOR_0":case"COLOR0":case"COLOR":s.addAttribute("color",p)}}void 0!==o.indices?(s.setIndex(t.accessors[o.indices]),n=new THREE.LineSegments(s,h)):n=new THREE.Line(s,h)}void 0!==s.attributes.color&&(h.vertexColors=THREE.VertexColors,h.needsUpdate=!0),n.name="0"===a?r.name:r.name+a,o.extras&&(n.userData=o.extras),r.add(n)}return r})})},h.prototype.loadCameras=function(){return s(this.json.cameras,function(e){if("perspective"==e.type&&e.perspective){var t=e.perspective.yfov,r=void 0!==e.perspective.aspectRatio?e.perspective.aspectRatio:1,i=t*r,a=new THREE.PerspectiveCamera(THREE.Math.radToDeg(i),r,e.perspective.znear||1,e.perspective.zfar||2e6);return void 0!==e.name&&(a.name=e.name),e.extras&&(a.userData=e.extras),a}if("orthographic"==e.type&&e.orthographic){a=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,e.orthographic.znear,e.orthographic.zfar);return void 0!==e.name&&(a.name=e.name),e.extras&&(a.userData=e.extras),a}})},h.prototype.loadSkins=function(){var e=this.json;return this._withDependencies(["accessors"]).then(function(t){return s(e.skins,function(e){var r=new THREE.Matrix4;return void 0!==e.bindShapeMatrix&&r.fromArray(e.bindShapeMatrix),{bindShapeMatrix:r,jointNames:e.jointNames,inverseBindMatrices:t.accessors[e.inverseBindMatrices]}})})},h.prototype.loadAnimations=function(){var e=this.json;return this._withDependencies(["accessors","nodes"]).then(function(t){return s(e.animations,function(e,r){var i=[];for(var a in e.channels){var s=e.channels[a],n=e.samplers[s.sampler];if(n){var o=s.target,c=o.node||o.id,h=void 0!==e.parameters?e.parameters[n.input]:n.input,l=void 0!==e.parameters?e.parameters[n.output]:n.output,u=t.accessors[h],d=t.accessors[l],p=t.nodes[c];if(p){p.updateMatrix(),p.matrixAutoUpdate=!0;var f=b[o.path]===b.rotation?THREE.QuaternionKeyframeTrack:THREE.VectorKeyframeTrack,m=p.name?p.name:p.uuid,v=void 0!==n.interpolation?R[n.interpolation]:THREE.InterpolateLinear;i.push(new f(m+"."+b[o.path],THREE.AnimationUtils.arraySlice(u.array,0),THREE.AnimationUtils.arraySlice(d.array,0),v))}}}c=void 0!==e.name?e.name:"animation_"+r;return new THREE.AnimationClip(c,void 0,i)})})},h.prototype.loadNodes=function(){var e=this.json,t=this.extensions,r=this;return s(e.nodes,function(e){var t,r=new THREE.Matrix4;return e.jointName?(t=new THREE.Bone,t.name=void 0!==e.name?e.name:e.jointName,t.jointName=e.jointName):(t=new THREE.Object3D,void 0!==e.name&&(t.name=e.name)),e.extras&&(t.userData=e.extras),void 0!==e.matrix?(r.fromArray(e.matrix),t.applyMatrix(r)):(void 0!==e.translation&&t.position.fromArray(e.translation),void 0!==e.rotation&&t.quaternion.fromArray(e.rotation),void 0!==e.scale&&t.scale.fromArray(e.scale)),t}).then(function(i){return r._withDependencies(["meshes","skins","cameras"]).then(function(r){return s(i,function(a,s){var n,o=e.nodes[s];if(void 0!==o.mesh?n=[o.mesh]:void 0!==o.meshes&&(console.warn("GLTFLoader: Legacy glTF file detected. Nodes may have no more than 1 mesh."),n=o.meshes),void 0!==n)for(var c in n){var h=n[c],u=r.meshes[h];if(void 0!==u)for(var d in u.children){var p,f=u.children[d],m=f.material,v=f.geometry,E=f.userData,g=f.name;switch(m.isDeferredShaderMaterial?m=p=m.create():p=m,f.type){case"LineSegments":f=new THREE.LineSegments(v,p);break;case"LineLoop":f=new THREE.LineLoop(v,p);break;case"Line":f=new THREE.Line(v,p);break;default:f=new THREE.Mesh(v,p)}f.castShadow=!0,f.userData=E,f.name=g;var T;if(void 0!==o.skin&&(T=r.skins[o.skin]),T){var y=v;(p=m).skinning=!0,(f=new THREE.SkinnedMesh(y,p,!1)).castShadow=!0,f.userData=E,f.name=g;for(var b=[],R=[],w=0,x=T.jointNames.length;w<x;w++){var H=T.jointNames[w],N=function(e){for(var t=Object.keys(i),r=0,a=t.length;r<a;r++){var s=i[t[r]];if(s.jointName===e)return s}return null}(H);if(N){b.push(N);var A=T.inverseBindMatrices.array,M=(new THREE.Matrix4).fromArray(A,16*w);R.push(M)}else console.warn("WARNING: joint: '"+H+"' could not be found")}f.bind(new THREE.Skeleton(b,R,!1),T.bindShapeMatrix);var L=function(t,r,a){var s=t[a];if(void 0!==s)for(var n=0,o=s.length;n<o;n++){var c=s[n],h=i[c],l=e.nodes[c];void 0!==h&&!0===h.isBone&&void 0!==l&&(r.add(h),L(l,h,"children"))}};L(o,f,"skeletons")}a.add(f)}else console.warn("GLTFLoader: Couldn't find node \""+h+'".')}if(void 0!==o.camera){var k=r.cameras[o.camera];a.add(k)}if(o.extensions&&o.extensions[l.KHR_MATERIALS_COMMON]&&o.extensions[l.KHR_MATERIALS_COMMON].light){var _=t[l.KHR_MATERIALS_COMMON].lights[o.extensions[l.KHR_MATERIALS_COMMON].light];a.add(_)}return a})})})},h.prototype.loadScenes=function(){function e(r,i,a){var s=a[r];i.add(s);var n=t.nodes[r];if(n.children)for(var o=n.children,c=0,h=o.length;c<h;c++)e(o[c],s,a)}var t=this.json;return this._withDependencies(["nodes"]).then(function(i){return s(t.scenes,function(t){var a=new THREE.Scene;void 0!==t.name&&(a.name=t.name),t.extras&&(a.userData=t.extras);for(var s=t.nodes||[],n=0,o=s.length;n<o;n++)e(s[n],a,i.nodes);return a.traverse(function(e){e.material&&e.material.isRawShaderMaterial&&(e.gltfShader=new r(e,i.nodes),e.onBeforeRender=function(e,t,r){this.gltfShader.update(t,r)})}),a})})},e}();